<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace — Wiser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/student.css">
  <link rel="icon" type="image/png" href="../assets/wiser-logo.png">
  <script>(function(){var t=localStorage.getItem('wiser_theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark')})()</script>
</head>
<body>
  <!-- Main Navigation -->
  <nav class="stu-navbar">
    <a href="../index.html" class="stu-navbar-logo">
      <img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-dark">
    </a>
    <div class="stu-navbar-center">
      <a href="../index.html">Home</a>
      <a href="explore.html">Courses</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="schools.html">Schools</a>
      <a href="shop.html" style="color:var(--primary-600);">Marketplace</a>
      <a href="learning-hub.html">Learning Hub</a>
    </div>
    <div class="stu-navbar-right">
      <button class="theme-toggle" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode"><svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
      <button class="stu-search-btn" onclick="document.querySelector('.stu-search-overlay').classList.toggle('active')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </button>
      <button class="stu-notif-btn" onclick="document.querySelector('.stu-notif-panel').classList.toggle('active');document.querySelector('.stu-notif-backdrop').classList.toggle('active')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span class="stu-notif-badge">3</span>
      </button>
      <button class="stu-cart-btn" onclick="toggleCart()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        <span class="stu-cart-badge" id="cartBadge">0</span>
      </button>
      <a href="explore.html" class="stu-enroll-btn">Enroll Now</a>
      <button class="stu-mobile-toggle" onclick="document.querySelector('.stu-mobile-menu').classList.toggle('active');document.querySelector('.stu-mobile-overlay').classList.toggle('active')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="stu-mobile-overlay" onclick="this.classList.remove('active');document.querySelector('.stu-mobile-menu').classList.remove('active')"></div>
  <div class="stu-mobile-menu">
    <a href="../index.html">Home</a>
    <a href="explore.html">Courses</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="schools.html">Schools</a>
    <a href="shop.html" style="color:var(--primary-600);font-weight:600;">Marketplace</a>
    <a href="learning-hub.html">Learning Hub</a>
    <a href="settings.html">Settings</a>
  </div>

  <!-- Search Overlay -->
  <div class="stu-search-overlay">
    <div class="stu-search-overlay-inner">
      <input type="text" placeholder="Search products, stores..." id="shopSearch" oninput="filterShop()">
      <button onclick="document.querySelector('.stu-search-overlay').classList.remove('active')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>

  <!-- Notification Panel -->
  <div class="stu-notif-panel">
    <div class="stu-notif-panel-header">
      <h3>Notifications</h3>
      <button class="stu-notif-mark-all" onclick="document.querySelectorAll('.stu-notif-item').forEach(i=>i.classList.remove('unread'));this.textContent='All Read ✓'">Mark all read</button>
      <button onclick="document.querySelector('.stu-notif-panel').classList.remove('active');document.querySelector('.stu-notif-backdrop').classList.remove('active')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="stu-notif-list" id="notifContainer"></div>
  </div>
  <div class="stu-notif-backdrop" onclick="document.querySelector('.stu-notif-panel').classList.remove('active');this.classList.remove('active')"></div>

  <!-- Body Layout -->
  <div class="stu-body">
    <!-- Sidebar -->
    <aside class="stu-sidebar">
      <div class="stu-sidebar-greeting">Welcome, Jordan Rivera</div>
      <ul class="stu-sidebar-nav">
        <li><a href="dashboard.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard</a></li>
        <li><a href="my-profile.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          My Profile</a></li>
        <li><a href="enrolled-courses.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          Enrolled Courses</a></li>
        <li><a href="shop.html" class="active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
          Marketplace</a></li>
        <li><a href="wishlist.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          Wishlist</a></li>
        <li><a href="reviews.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Reviews</a></li>
        <li><a href="quiz-attempts.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          My Quiz Attempts</a></li>
        <li><a href="order-history.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          Order History</a></li>
      </ul>
      <div class="stu-sidebar-divider"></div>
      <div class="stu-sidebar-section-label">User</div>
      <ul class="stu-sidebar-nav">
        <li><a href="settings.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings</a></li>
        <li><a href="../auth/login.html">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Logout</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <div class="stu-main">
      <h2 class="stu-main-title"><span class="wi wi-shopping-bag"></span> Marketplace</h2>
      <p style="color: var(--gray-500); font-size: 14px; margin-top: -16px; margin-bottom: 24px;">Browse digital products, bundles, and resources from top instructors</p>

      <!-- Marketplace Tabs & Search -->
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:24px;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="shop-filter-btn active" onclick="switchShopTab('stores',this)"><span class="wi wi-store"></span> Stores</button>
          <button class="shop-filter-btn" onclick="switchShopTab('products',this)"><span class="wi wi-package"></span> Products</button>
          <button class="shop-filter-btn" onclick="switchShopTab('bundles',this)"><span class="wi wi-gift"></span> Bundles</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="text" id="shopSearchInline" placeholder="Search marketplace..." oninput="filterShop()" style="padding:8px 14px;border:1px solid var(--border-light,#e5e7eb);border-radius:var(--radius-md,10px);font-size:13px;background:var(--bg-primary,#fff);color:var(--text-primary);width:200px;font-family:inherit;">
          <div style="position:relative;">
            <input type="text" id="couponInput" placeholder="Coupon code" style="padding:8px 14px;border:1px solid var(--border-light,#e5e7eb);border-radius:var(--radius-md,10px);font-size:13px;background:var(--bg-primary,#fff);color:var(--text-primary);width:140px;font-family:inherit;">
            <button onclick="applyCoupon()" style="position:absolute;right:4px;top:50%;transform:translateY(-50%);padding:4px 10px;background:var(--primary-600,#3d8b1c);color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-family:inherit;">Apply</button>
          </div>
        </div>
      </div>

      <!-- Tab Panels -->
      <div id="shopStoresPanel"></div>
      <div id="shopProductsPanel" style="display:none"></div>
      <div id="shopBundlesPanel" style="display:none"></div>
    </div>
  </div>

  <!-- Cart Sidebar -->
  <div class="shop-cart-backdrop" id="cartBackdrop" onclick="toggleCart()"></div>
  <div class="shop-cart-panel" id="cartPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border-light,#e5e7eb);">
      <h3 style="font-size:16px;font-weight:700;color:var(--text-primary);"><span class="wi wi-cart"></span> Your Cart</h3>
      <button onclick="toggleCart()" style="background:var(--bg-secondary,#f3f4f6);border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="cartItems" style="flex:1;overflow-y:auto;padding:16px 20px;"></div>
    <div style="padding:16px 20px;border-top:1px solid var(--border-light,#e5e7eb);">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:13px;color:var(--text-secondary);">Subtotal</span><span id="cartSubtotal" style="font-size:13px;font-weight:600;">$0.00</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;" id="cartDiscountRow" hidden><span style="font-size:13px;color:#16a34a;">Discount</span><span id="cartDiscount" style="font-size:13px;font-weight:600;color:#16a34a;">-$0.00</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:16px;padding-top:8px;border-top:1px solid var(--border-light,#e5e7eb);"><span style="font-size:15px;font-weight:700;color:var(--text-primary);">Total</span><span id="cartTotal" style="font-size:15px;font-weight:700;color:var(--primary-600,#3d8b1c);">$0.00</span></div>
      <button onclick="checkout()" class="btn btn-primary" style="width:100%;justify-content:center;">Proceed to Checkout →</button>
    </div>
  </div>

  <!-- Store Detail Modal -->
  <div class="shop-modal-overlay" id="storeModal" onclick="if(event.target===this)closeStoreModal()">
    <div class="shop-modal-card" id="storeModalContent"></div>
  </div>

  <!-- Product Detail Modal -->
  <div class="shop-modal-overlay" id="productModal" onclick="if(event.target===this)closeProductModal()">
    <div class="shop-modal-card shop-modal-sm" id="productModalContent"></div>
  </div>

  <style>
    .shop-filter-btn {
      padding: 8px 18px;
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 20px;
      background: var(--bg-primary, #fff);
      color: var(--text-secondary, #6b7280);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .shop-filter-btn:hover { border-color: var(--primary-600); color: var(--primary-600); }
    .shop-filter-btn.active { background: var(--primary-600, #3d8b1c); color: #fff; border-color: var(--primary-600); }

    /* Store Cards */
    .shop-store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
    .shop-store-card {
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-primary, #fff);
      cursor: pointer;
      transition: all 0.3s;
    }
    .shop-store-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.1); }
    .shop-store-banner { height: 100px; position: relative; }
    .shop-store-logo {
      position: absolute; bottom: -20px; left: 16px;
      width: 44px; height: 44px; border-radius: 12px;
      border: 3px solid var(--bg-primary, #fff);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: #fff;
      overflow: hidden;
    }
    .shop-store-body { padding: 28px 16px 16px; }
    .shop-store-name { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .shop-store-verified { color: #3d8b1c; }
    .shop-store-tagline { font-size: 12px; color: var(--text-tertiary, #9ca3af); margin-bottom: 8px; }
    .shop-store-owner { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; }
    .shop-store-owner img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
    .shop-store-stats { display: flex; gap: 16px; font-size: 12px; color: var(--text-tertiary); }
    .shop-store-stats span { display: flex; align-items: center; gap: 4px; }

    /* Product Cards */
    .shop-product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .shop-product-card {
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-primary, #fff);
      transition: all 0.3s;
    }
    .shop-product-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .shop-product-img { height: 120px; display: flex; align-items: center; justify-content: center; font-size: 36px; position: relative; }
    .shop-product-type {
      position: absolute; top: 8px; right: 8px;
      font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
      padding: 3px 8px; border-radius: 6px;
      background: rgba(0,0,0,0.5); color: #fff; backdrop-filter: blur(4px);
    }
    .shop-product-body { padding: 14px; }
    .shop-product-name { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
    .shop-product-desc { font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
    .shop-product-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px; }
    .shop-product-price { display: flex; align-items: center; justify-content: space-between; }
    .shop-product-price-current { font-size: 18px; font-weight: 800; color: var(--primary-600, #3d8b1c); }
    .shop-product-price-original { font-size: 12px; color: var(--text-tertiary); text-decoration: line-through; margin-left: 6px; }
    .shop-add-btn {
      padding: 6px 14px; border: none; border-radius: 8px;
      background: var(--primary-600, #3d8b1c); color: #fff;
      font-size: 12px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: all 0.2s;
    }
    .shop-add-btn:hover { transform: scale(1.03); box-shadow: 0 2px 8px rgba(61,139,28,0.3); }
    .shop-add-btn.added { background: var(--bg-tertiary, #e5e7eb); color: var(--text-tertiary); }

    /* Bundle Cards */
    .shop-bundle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .shop-bundle-card {
      border: 2px solid var(--border-light, #e5e7eb);
      border-radius: 16px;
      padding: 20px;
      background: var(--bg-primary, #fff);
      transition: all 0.3s;
      position: relative;
    }
    .shop-bundle-card:hover { border-color: var(--primary-600); box-shadow: 0 8px 24px rgba(61,139,28,0.1); }
    .shop-bundle-save {
      position: absolute; top: 12px; right: 12px;
      padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;
      background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #16a34a;
    }
    .shop-bundle-icon { font-size: 32px; margin-bottom: 8px; }
    .shop-bundle-name { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .shop-bundle-desc { font-size: 12px; color: var(--text-tertiary); margin-bottom: 12px; line-height: 1.5; }
    .shop-bundle-courses { margin-bottom: 12px; }
    .shop-bundle-course-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 0; font-size: 13px; color: var(--text-secondary);
      border-bottom: 1px solid var(--bg-secondary, #f3f4f6);
    }
    .shop-bundle-course-item:last-child { border-bottom: none; }
    .shop-bundle-pricing { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light, #e5e7eb); }

    /* Cart */
    .shop-cart-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; }
    .shop-cart-backdrop.active { display: block; }
    .shop-cart-panel {
      position: fixed; top: 0; right: 0; bottom: 0; width: 380px; max-width: 100%;
      background: var(--bg-primary, #fff); z-index: 901; display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.3s;
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
    }
    .shop-cart-panel.active { transform: translateX(0); }
    .shop-cart-item {
      display: flex; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid var(--bg-secondary, #f3f4f6);
    }
    .shop-cart-item-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .shop-cart-item-info { flex: 1; min-width: 0; }
    .shop-cart-item-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .shop-cart-item-seller { font-size: 11px; color: var(--text-tertiary); }
    .shop-cart-item-price { font-size: 13px; font-weight: 700; color: var(--primary-600); }
    .shop-cart-remove { background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 4px; }
    .shop-cart-remove:hover { color: #ef4444; }

    /* Modals */
    .shop-modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.6); align-items: flex-start; justify-content: center;
      padding: 40px 20px; overflow-y: auto;
    }
    .shop-modal-overlay.active { display: flex; }
    .shop-modal-card {
      background: var(--bg-primary, #fff); border-radius: 20px;
      max-width: 800px; width: 100%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25); position: relative;
      max-height: 90vh; overflow-y: auto;
    }
    .shop-modal-sm { max-width: 520px; }
    .shop-modal-close {
      position: absolute; top: 12px; right: 12px; border: none;
      background: rgba(0,0,0,0.06); border-radius: 50%; width: 36px; height: 36px;
      font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      z-index: 2; color: var(--text-secondary);
    }

    /* Empty state */
    .shop-empty { text-align: center; padding: 48px 20px; color: var(--text-tertiary); }
    .shop-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .shop-empty-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-secondary); }
    .shop-empty-text { font-size: 13px; }

    /* Responsive */
    @media (max-width: 768px) {
      .shop-store-grid { grid-template-columns: 1fr; }
      .shop-product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
      .shop-bundle-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 480px) {
      .shop-product-grid { grid-template-columns: 1fr 1fr; }
    }

    /* Dark mode extras */
    [data-theme="dark"] .shop-store-card { background: var(--bg-secondary); border-color: rgba(159,232,112,0.1); }
    [data-theme="dark"] .shop-store-card:hover { box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
    [data-theme="dark"] .shop-store-logo { border-color: var(--bg-secondary); }
    [data-theme="dark"] .shop-product-card { background: var(--bg-secondary); border-color: rgba(159,232,112,0.1); }
    [data-theme="dark"] .shop-product-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    [data-theme="dark"] .shop-bundle-card { background: var(--bg-secondary); border-color: rgba(159,232,112,0.1); }
    [data-theme="dark"] .shop-bundle-card:hover { border-color: #9fe870; }
    [data-theme="dark"] .shop-bundle-save { background: rgba(159,232,112,0.12); color: #9fe870; }
    [data-theme="dark"] .shop-cart-panel { background: var(--bg-secondary); }
    [data-theme="dark"] .shop-modal-card { background: var(--bg-secondary); }
    [data-theme="dark"] .shop-modal-close { background: rgba(255,255,255,0.08); color: #c2eb9e; }
    [data-theme="dark"] .shop-filter-btn { background: var(--bg-secondary); border-color: rgba(159,232,112,0.1); color: #c2eb9e; }
    [data-theme="dark"] .shop-filter-btn:hover { border-color: #9fe870; color: #9fe870; }
    [data-theme="dark"] .shop-filter-btn.active { background: #3d8b1c; color: #fff; border-color: #3d8b1c; }
    [data-theme="dark"] #shopSearchInline, [data-theme="dark"] #couponInput {
      background: var(--bg-tertiary); border-color: rgba(159,232,112,0.1); color: #e0f5cc;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.2/dist/umd/supabase.min.js" integrity="sha384-zhtfJ1S/qkpAToBl4XpbM2NH5uZgfUq2z4qo30Ed7TxgPxmkM+L1Gm94iyexzcJ6" crossorigin="anonymous"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
  <script src="../js/app.js"></script>
  <script>
    // =====================================
    // STATE
    // =====================================
    let cart = [];
    let appliedCoupon = null;
    let currentTab = 'stores';
    let allStores = [];

    // =====================================
    // INIT
    // =====================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Auth guard — server-side role verification
      const __authProfile = await WiserAuth.requireAuth(['student', 'admin']);
      if (!__authProfile) return;

      try {
        const { user, profile, displayName, firstName } = await StudentPage.init();
        // Load cart and stores in parallel
        const [stores, cartItems] = await Promise.all([
          WiserData.getTeacherStores().catch(() => []),
          WiserAPI.cart.getItems().catch(() => [])
        ]);
        allStores = stores || [];
        cart = cartItems || [];
        renderStores();
        renderAllProducts();
        renderAllBundles();
        updateCartBadge();
      } catch(err) {
        console.error('Shop init error:', err);
      }
    });

    // =====================================
    // TAB SWITCHING
    // =====================================
    function switchShopTab(tab, btn) {
      currentTab = tab;
      document.querySelectorAll('.shop-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('shopStoresPanel').style.display = tab === 'stores' ? '' : 'none';
      document.getElementById('shopProductsPanel').style.display = tab === 'products' ? '' : 'none';
      document.getElementById('shopBundlesPanel').style.display = tab === 'bundles' ? '' : 'none';
    }

    // =====================================
    // RENDER STORES
    // =====================================
    function renderStores() {
      const stores = allStores;
      document.getElementById('shopStoresPanel').innerHTML = `
        <div class="shop-store-grid">
          ${stores.map(store => `
            <div class="shop-store-card" onclick="openStoreModal(${store.id})">
              <div class="shop-store-banner" style="background:${store.banner}">
                <div class="shop-store-logo" style="background:${store.banner}">
                  ${store.initials}
                </div>
              </div>
              <div class="shop-store-body">
                <div class="shop-store-name">
                  ${WiserSanitize.e(store.name)}
                  ${store.verified ? '<svg class="shop-store-verified" width="16" height="16" viewBox="0 0 24 24" fill="#3d8b1c"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' : ''}
                </div>
                <div class="shop-store-tagline">${WiserSanitize.e(store.tagline)}</div>
                <div class="shop-store-owner">
                  <img src="${store.ownerAvatar}" alt="${WiserSanitize.e(store.owner)}">
                  <span>${WiserSanitize.e(store.owner)}</span>
                </div>
                <div class="shop-store-stats">
                  <span><span class="wi wi-star"></span> ${store.rating}</span>
                  <span><span class="wi wi-users"></span> ${store.students.toLocaleString()} students</span>
                  <span><span class="wi wi-package"></span> ${store.products.length} products</span>
                  <span><span class="wi wi-gift"></span> ${store.bundles.length} bundles</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // =====================================
    // RENDER ALL PRODUCTS
    // =====================================
    function renderAllProducts() {
      const stores = allStores;
      const allProducts = [];
      stores.forEach(s => {
        s.products.forEach(p => allProducts.push({ ...p, storeName: s.name, storeOwner: s.owner, storeId: s.id }));
      });
      document.getElementById('shopProductsPanel').innerHTML = `
        <div class="shop-product-grid" id="productsGrid">
          ${allProducts.map(p => renderProductCard(p)).join('')}
        </div>
      `;
    }

    function renderProductCard(p) {
      const inCart = cart.some(c => c.id === p.id);
      return `
        <div class="shop-product-card" data-name="${WiserSanitize.e(p.name.toLowerCase())}" data-store="${WiserSanitize.e((p.storeName||'').toLowerCase())}">
          <div class="shop-product-img" style="background:${p.image}" onclick="openProductModal(${p.id})">
            ${p.icon}
            <span class="shop-product-type">${p.type}</span>
          </div>
          <div class="shop-product-body">
            <div class="shop-product-name">${WiserSanitize.e(p.name)}</div>
            <div class="shop-product-desc">${WiserSanitize.e(p.description || '')}</div>
            <div class="shop-product-meta">
              <span><span class="wi wi-star"></span> ${p.rating || '4.7'}</span>
              <span><span class="wi wi-trending"></span> ${p.sales} sold</span>
              ${p.storeOwner ? `<span>by ${WiserSanitize.e(p.storeOwner)}</span>` : ''}
            </div>
            <div class="shop-product-price">
              <div>
                <span class="shop-product-price-current">$${p.price.toFixed(2)}</span>
                ${p.originalPrice ? `<span class="shop-product-price-original">$${p.originalPrice.toFixed(2)}</span>` : ''}
              </div>
              <button class="shop-add-btn ${inCart ? 'added' : ''}" onclick="event.stopPropagation();${inCart ? `removeFromCart(${p.id})` : `addToCart(${p.id},'product')`}">
                ${inCart ? '✓ In Cart' : '+ Add'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // =====================================
    // RENDER ALL BUNDLES
    // =====================================
    function renderAllBundles() {
      const stores = allStores;
      const allBundles = [];
      stores.forEach(s => {
        s.bundles.forEach(b => allBundles.push({ ...b, storeName: s.name, storeOwner: s.owner, storeId: s.id }));
      });
      document.getElementById('shopBundlesPanel').innerHTML = `
        <div class="shop-bundle-grid">
          ${allBundles.map(b => {
            const inCart = cart.some(c => c.id === b.id);
            return `
              <div class="shop-bundle-card" data-name="${WiserSanitize.e(b.name.toLowerCase())}" data-store="${WiserSanitize.e((b.storeName||'').toLowerCase())}">
                <div class="shop-bundle-save">Save ${b.savings}</div>
                <div class="shop-bundle-icon">${b.icon}</div>
                <div class="shop-bundle-name">${WiserSanitize.e(b.name)}</div>
                <div class="shop-bundle-desc">${WiserSanitize.e(b.description)}</div>
                <div class="shop-bundle-courses">
                  ${b.courses.map(c => `<div class="shop-bundle-course-item"><span class="wi wi-book"></span> ${WiserSanitize.e(c)}</div>`).join('')}
                </div>
                <div style="font-size:12px;color:var(--text-tertiary);margin-bottom:8px;">by ${WiserSanitize.e(b.storeOwner)} · ${b.sales} purchased</div>
                <div class="shop-bundle-pricing">
                  <div>
                    <span style="font-size:20px;font-weight:800;color:var(--primary-600,#3d8b1c);">$${b.price.toFixed(2)}</span>
                    <span style="font-size:13px;color:var(--text-tertiary);text-decoration:line-through;margin-left:6px;">$${b.originalPrice.toFixed(2)}</span>
                  </div>
                  <button class="shop-add-btn ${inCart ? 'added' : ''}" onclick="${inCart ? `removeFromCart(${b.id})` : `addToCart(${b.id},'bundle')`}">
                    ${inCart ? '✓ In Cart' : '+ Add to Cart'}
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // =====================================
    // STORE MODAL
    // =====================================
    function openStoreModal(storeId) {
      const store = allStores.find(s => s.id === storeId);
      if (!store) return;
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const modal = document.getElementById('storeModal');
      document.getElementById('storeModalContent').innerHTML = `
        <button class="shop-modal-close" onclick="closeStoreModal()">✕</button>
        <div style="height:140px;background:${store.banner};border-radius:20px 20px 0 0;position:relative;">
          <div style="position:absolute;bottom:-28px;left:24px;width:56px;height:56px;border-radius:16px;background:${store.banner};border:4px solid var(--bg-primary,#fff);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff;">${store.initials}</div>
        </div>
        <div style="padding:36px 24px 24px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <h2 style="font-size:22px;font-weight:800;color:var(--text-primary);">${WiserSanitize.e(store.name)}</h2>
            ${store.verified ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="#3d8b1c"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' : ''}
          </div>
          <p style="font-size:13px;color:var(--text-tertiary);margin-bottom:12px;">${WiserSanitize.e(store.tagline)}</p>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
            <img src="${store.ownerAvatar}" alt="${WiserSanitize.e(store.owner)}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--text-primary);">${WiserSanitize.e(store.owner)}</div>
              <div style="font-size:11px;color:var(--text-tertiary);"><span class="wi wi-star"></span> ${store.rating} · ${store.reviews.toLocaleString()} reviews · ${store.students.toLocaleString()} students</div>
            </div>
          </div>
          <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:20px;">${WiserSanitize.e(store.bio)}</p>

          ${store.coupons.length ? `
          <div style="padding:12px 16px;border:1px dashed var(--primary-600,#3d8b1c);border-radius:12px;background:rgba(61,139,28,0.04);margin-bottom:20px;">
            <div style="font-size:11px;font-weight:700;color:var(--primary-600,#3d8b1c);text-transform:uppercase;margin-bottom:6px;"><span class="wi wi-tag"></span> Available Coupons</div>
            ${store.coupons.map(c => `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;">
              <div><code style="font-size:12px;font-weight:700;background:var(--bg-secondary,#f3f4f6);padding:3px 8px;border-radius:4px;">${c.code}</code> <span style="font-size:12px;color:var(--text-secondary);margin-left:6px;">${c.discount} off${c.minPurchase ? ' · Min $' + c.minPurchase : ''}</span></div>
              <button onclick="navigator.clipboard.writeText('${c.code}');Toast.show('Copied!','Code ${c.code} copied','success',2000)" style="font-size:11px;padding:4px 10px;background:var(--primary-600,#3d8b1c);color:#fff;border:none;border-radius:6px;cursor:pointer;">Copy</button>
            </div>`).join('')}
          </div>` : ''}

          <h3 style="font-size:15px;font-weight:700;margin-bottom:12px;color:var(--text-primary);"><span class="wi wi-package"></span> Products (${store.products.length})</h3>
          <div class="shop-product-grid" style="margin-bottom:20px;">
            ${store.products.map(p => renderProductCard({ ...p, storeName: store.name, storeOwner: store.owner, storeId: store.id })).join('')}
          </div>

          ${store.bundles.length ? `
          <h3 style="font-size:15px;font-weight:700;margin-bottom:12px;color:var(--text-primary);"><span class="wi wi-gift"></span> Bundles (${store.bundles.length})</h3>
          ${store.bundles.map(b => {
            const inCart = cart.some(c => c.id === b.id);
            return `<div style="border:1px solid var(--border-light,#e5e7eb);border-radius:14px;padding:16px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-size:15px;font-weight:700;color:var(--text-primary);">${b.icon} ${WiserSanitize.e(b.name)}</div>
                  <div style="font-size:12px;color:var(--text-tertiary);margin-top:2px;">${b.courses.length} courses · Save ${b.savings}</div>
                </div>
                <div style="text-align:right;">
                  <div><span style="font-size:18px;font-weight:800;color:var(--primary-600);">$${b.price.toFixed(2)}</span> <span style="font-size:12px;color:var(--text-tertiary);text-decoration:line-through;">$${b.originalPrice.toFixed(2)}</span></div>
                  <button class="shop-add-btn ${inCart?'added':''}" style="margin-top:6px;" onclick="${inCart ? `removeFromCart(${b.id})` : `addToCart(${b.id},'bundle')`}">${inCart ? '✓ In Cart' : '+ Add'}</button>
                </div>
              </div>
            </div>`;
          }).join('')}` : ''}
        </div>
      `;
      modal.classList.add('active');
    }

    function closeStoreModal() {
      document.getElementById('storeModal').classList.remove('active');
    }

    // =====================================
    // PRODUCT MODAL
    // =====================================
    function openProductModal(productId) {
      const stores = allStores;
      let product = null, store = null;
      for (const s of stores) {
        const p = s.products.find(pr => pr.id === productId);
        if (p) { product = p; store = s; break; }
      }
      if (!product) return;
      const inCart = cart.some(c => c.id === product.id);
      document.getElementById('productModalContent').innerHTML = `
        <button class="shop-modal-close" onclick="closeProductModal()">✕</button>
        <div style="height:180px;background:${product.image};display:flex;align-items:center;justify-content:center;font-size:64px;border-radius:20px 20px 0 0;">${product.icon}</div>
        <div style="padding:24px;">
          <span style="display:inline-block;font-size:10px;font-weight:700;text-transform:uppercase;padding:3px 10px;border-radius:20px;background:rgba(61,139,28,0.1);color:var(--primary-600);margin-bottom:10px;">${product.type}</span>
          <h2 style="font-size:20px;font-weight:800;color:var(--text-primary);margin-bottom:6px;">${WiserSanitize.e(product.name)}</h2>
          <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:16px;">${WiserSanitize.e(product.description)}</p>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding:12px;background:var(--bg-secondary,#f9fafb);border-radius:12px;">
            <img src="${store.ownerAvatar}" alt="${WiserSanitize.e(store.owner)}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--text-primary);">${WiserSanitize.e(store.owner)}</div>
              <div style="font-size:11px;color:var(--text-tertiary);">${WiserSanitize.e(store.name)}</div>
            </div>
          </div>
          <div style="display:flex;gap:20px;margin-bottom:20px;font-size:13px;color:var(--text-tertiary);">
            <span><span class="wi wi-star"></span> ${product.rating} rating</span>
            <span><span class="wi wi-trending"></span> ${product.sales.toLocaleString()} sold</span>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:16px;border:1px solid var(--border-light,#e5e7eb);border-radius:14px;">
            <div>
              <span style="font-size:28px;font-weight:800;color:var(--primary-600,#3d8b1c);">$${product.price.toFixed(2)}</span>
              ${product.originalPrice ? `<span style="font-size:14px;color:var(--text-tertiary);text-decoration:line-through;margin-left:8px;">$${product.originalPrice.toFixed(2)}</span>` : ''}
            </div>
            <button class="shop-add-btn ${inCart?'added':''}" style="padding:10px 24px;font-size:14px;" onclick="${inCart ? `removeFromCart(${product.id});closeProductModal()` : `addToCart(${product.id},'product');closeProductModal()`}">
              ${inCart ? '✓ In Cart' : '<span class="wi wi-cart"></span> Add to Cart'}
            </button>
          </div>
        </div>
      `;
      document.getElementById('productModal').classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
    }

    // =====================================
    // CART
    // =====================================
    function findItem(id, type) {
      const stores = allStores;
      for (const s of stores) {
        if (type === 'product') {
          const p = s.products.find(pr => pr.id === id);
          if (p) return { ...p, storeName: s.name, storeOwner: s.owner, itemType: 'product' };
        } else {
          const b = s.bundles.find(b => b.id === id);
          if (b) return { ...b, storeName: s.name, storeOwner: s.owner, itemType: 'bundle' };
        }
      }
      return null;
    }

    function addToCart(id, type) {
      if (cart.some(c => c.id === id)) return;
      const item = findItem(id, type);
      if (!item) return;
      cart.push({ id: item.id, name: item.name, price: item.price, icon: item.icon, storeName: item.storeName, storeOwner: item.storeOwner, type: type });
      WiserAPI.cart.addItem({ product_id: item.id, product_type: type, quantity: 1 }).catch(e => console.warn('Cart save error:', e));
      updateCartBadge();
      renderAllProducts();
      renderAllBundles();
      Toast.show('Added to cart!', item.name, 'success', 2000);
    }

    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      WiserAPI.cart.removeItem(id).catch(e => console.warn('Cart remove error:', e));
      updateCartBadge();
      renderCartItems();
      renderAllProducts();
      renderAllBundles();
      Toast.show('Removed from cart', '', 'info', 2000);
    }

    function updateCartBadge() {
      document.getElementById('cartBadge').textContent = cart.length;
      document.getElementById('cartBadge').style.display = cart.length > 0 ? '' : 'none';
    }

    function toggleCart() {
      document.getElementById('cartPanel').classList.toggle('active');
      document.getElementById('cartBackdrop').classList.toggle('active');
      renderCartItems();
    }

    function renderCartItems() {
      const container = document.getElementById('cartItems');
      if (cart.length === 0) {
        container.innerHTML = '<div class="shop-empty"><div class="shop-empty-icon"><span class="wi wi-cart"></span></div><div class="shop-empty-title">Your cart is empty</div><div class="shop-empty-text">Browse the marketplace to add items</div></div>';
      } else {
        container.innerHTML = cart.map(item => `
          <div class="shop-cart-item">
            <div class="shop-cart-item-icon" style="background:var(--bg-secondary,#f3f4f6)">${item.icon}</div>
            <div class="shop-cart-item-info">
              <div class="shop-cart-item-name">${WiserSanitize.e(item.name)}</div>
              <div class="shop-cart-item-seller">by ${WiserSanitize.e(item.storeOwner)}</div>
              <div class="shop-cart-item-price">$${item.price.toFixed(2)}</div>
            </div>
            <button class="shop-cart-remove" onclick="removeFromCart(${item.id})">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        `).join('');
      }
      // Calculate totals
      const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
      let discount = 0;
      if (appliedCoupon) {
        const pct = parseInt(appliedCoupon.discount) / 100;
        discount = subtotal * pct;
      }
      const total = subtotal - discount;
      document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
      if (appliedCoupon) {
        document.getElementById('cartDiscountRow').hidden = false;
        document.getElementById('cartDiscount').textContent = '-$' + discount.toFixed(2);
      } else {
        document.getElementById('cartDiscountRow').hidden = true;
      }
    }

    // =====================================
    // COUPON
    // =====================================
    function applyCoupon() {
      const code = document.getElementById('couponInput').value.trim().toUpperCase();
      if (!code) { Toast.show('Enter a coupon code', '', 'error', 2000); return; }
      const stores = allStores;
      let foundCoupon = null;
      for (const s of stores) {
        const c = s.coupons.find(c => c.code === code);
        if (c) { foundCoupon = c; break; }
      }
      if (!foundCoupon) {
        Toast.show('Invalid coupon', 'This coupon code does not exist', 'error', 2000);
        return;
      }
      const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
      if (foundCoupon.minPurchase && subtotal < foundCoupon.minPurchase) {
        Toast.show('Minimum not met', `This coupon requires a minimum purchase of $${foundCoupon.minPurchase}`, 'error', 2500);
        return;
      }
      appliedCoupon = foundCoupon;
      renderCartItems();
      Toast.show(`Coupon applied! ${foundCoupon.discount} off`, `Code: ${code}`, 'success', 3000);
    }

    // =====================================
    // CHECKOUT
    // =====================================
    async function checkout() {
      if (cart.length === 0) { Toast.show('Cart is empty', 'Add items to your cart first', 'error', 2000); return; }
      const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
      let discount = 0;
      if (appliedCoupon) discount = subtotal * (parseInt(appliedCoupon.discount) / 100);
      const total = subtotal - discount;

      // Save order to Supabase
      try {
        await WiserAPI.orders.create({
          items: [...cart],
          subtotal, discount, total,
          coupon: appliedCoupon ? appliedCoupon.code : null,
          status: 'completed'
        });
      } catch(e) { console.warn('Order save error:', e); }

      // Clear cart
      cart = [];
      appliedCoupon = null;
      WiserAPI.cart.clear().catch(e => console.warn(e));
      updateCartBadge();
      renderCartItems();
      toggleCart();

      Toast.show('<span class="wi wi-gift"></span> Purchase complete!', `Total: $${total.toFixed(2)} — Check your order history`, 'success', 4000);
    }

    // =====================================
    // SEARCH / FILTER
    // =====================================
    function filterShop() {
      const q = (document.getElementById('shopSearchInline').value || document.getElementById('shopSearch')?.value || '').toLowerCase();
      if (currentTab === 'products') {
        document.querySelectorAll('.shop-product-card').forEach(card => {
          const name = card.dataset.name || '';
          const store = card.dataset.store || '';
          card.style.display = (name.includes(q) || store.includes(q)) ? '' : 'none';
        });
      } else if (currentTab === 'bundles') {
        document.querySelectorAll('.shop-bundle-card').forEach(card => {
          const name = card.dataset.name || '';
          const store = card.dataset.store || '';
          card.style.display = (name.includes(q) || store.includes(q)) ? '' : 'none';
        });
      }
    }
  </script>
</body>
</html>
