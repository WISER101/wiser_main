<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Admin — Wiser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script>(function(){var t=localStorage.getItem('wiser_theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark')})()</script>
</head>
<body>
  <div class="app-layout">
    <!-- Admin Sidebar -->
    <aside class="sidebar admin-sidebar">
      <div class="sidebar-logo">
        <a href="dashboard.html">
          <img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-icon logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-icon logo-dark">
        </a>
        <span class="admin-badge">Admin</span>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-nav-label">Overview</div>
        <a href="dashboard.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard
        </a>
        <a href="users.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Users
        </a>
        <div class="sidebar-nav-label">Content</div>
        <a href="courses.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          Courses
        </a>
        <a href="reports.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Reports
        </a>
        <div class="sidebar-nav-label">Finance</div>
        <a href="revenue.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Revenue
        </a>
        <div class="sidebar-nav-label">System</div>
        <a href="settings.html" class="sidebar-link active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-user">
        <div class="avatar avatar-sm" style="background: linear-gradient(135deg, #DC2626, #5ab82e)">A</div>
        <div class="sidebar-user-info">
          <span class="sidebar-user-name">Admin</span>
          <span class="sidebar-user-role">Super Admin</span>
        </div>
      </div>
    </aside>

    <div class="sidebar-overlay" onclick="document.body.classList.remove('sidebar-open')"></div>

    <main class="main-content">
      <header class="top-header">
        <button class="sidebar-toggle" onclick="document.body.classList.toggle('sidebar-open')">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <h2 class="page-title">Platform Settings</h2>
        <div style="flex:1"></div>
        <div class="header-actions">
          <button class="theme-toggle" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode" style="background:none;border:none;cursor:pointer;padding:6px;"><svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
        </div>
      </header>

      <!-- Settings Layout -->
      <div class="admin-settings-grid">
        <!-- Settings Navigation -->
        <div class="admin-settings-nav">
          <a href="#general" class="settings-nav-item active" onclick="switchSettingsTab(this, 'general')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
            General
          </a>
          <a href="#email" class="settings-nav-item" onclick="switchSettingsTab(this, 'email')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Email & Notifications
          </a>
          <a href="#payments" class="settings-nav-item" onclick="switchSettingsTab(this, 'payments')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Payments
          </a>
          <a href="#security" class="settings-nav-item" onclick="switchSettingsTab(this, 'security')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Security
          </a>
          <a href="#api" class="settings-nav-item" onclick="switchSettingsTab(this, 'api')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            API & Integrations
          </a>
        </div>

        <!-- Settings Content -->
        <div class="admin-settings-content">
          <!-- General Settings -->
          <div class="settings-panel active" id="panel-general">
            <div class="card">
              <div class="card-header"><h3 class="card-title">General Settings</h3></div>
              <div style="padding:24px;display:flex;flex-direction:column;gap:20px;">
                <div class="admin-form-group">
                  <label>Platform Name</label>
                  <input type="text" value="Wiser" id="platformName">
                </div>
                <div class="admin-form-group">
                  <label>Tagline</label>
                  <input type="text" value="Making education more accessible" id="platformTagline">
                </div>
                <div class="admin-form-group">
                  <label>Support Email</label>
                  <input type="email" value="support@wiser.edu" id="supportEmail">
                </div>
                <div class="admin-form-row">
                  <div class="admin-form-group">
                    <label>Language</label>
                    <select id="platformLang">
                      <option selected>English</option>
                      <option>Spanish</option>
                      <option>French</option>
                      <option>German</option>
                      <option>Japanese</option>
                    </select>
                  </div>
                  <div class="admin-form-group">
                    <label>Timezone</label>
                    <select id="platformTimezone">
                      <option>UTC-8 (PST)</option>
                      <option selected>UTC-5 (EST)</option>
                      <option>UTC+0 (GMT)</option>
                      <option>UTC+1 (CET)</option>
                      <option>UTC+9 (JST)</option>
                    </select>
                  </div>
                </div>
                <div class="admin-form-group">
                  <label>Maintenance Mode</label>
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;color:var(--text-secondary);">Enable maintenance mode (disables user access)</span>
                    <label class="toggle-switch">
                      <input type="checkbox" id="maintenanceToggle">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;padding-top:8px;">
                  <button class="btn btn-secondary" onclick="showToast('Changes discarded','info')">Cancel</button>
                  <button class="btn btn-primary" onclick="saveAdminGeneral()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Email Settings -->
          <div class="settings-panel" id="panel-email">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Email & Notification Settings</h3></div>
              <div style="padding:24px;display:flex;flex-direction:column;gap:20px;">
                <div class="admin-form-row">
                  <div class="admin-form-group">
                    <label>SMTP Host</label>
                    <input type="text" value="smtp.wiser.edu" placeholder="smtp.example.com">
                  </div>
                  <div class="admin-form-group">
                    <label>SMTP Port</label>
                    <input type="number" value="587" placeholder="587">
                  </div>
                </div>
                <div class="admin-form-row">
                  <div class="admin-form-group">
                    <label>SMTP Username</label>
                    <input type="text" value="noreply@wiser.edu">
                  </div>
                  <div class="admin-form-group">
                    <label>SMTP Password</label>
                    <input type="password" value="••••••••">
                  </div>
                </div>
                <hr style="border:none;border-top:1px solid var(--border-light);margin:4px 0;">
                <h4 style="font-size:14px;font-weight:600;">Notification Preferences</h4>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;">New user registration alerts</span>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;">Course submission notifications</span>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;">Revenue milestone alerts</span>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;">System error notifications</span>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;padding-top:8px;">
                  <button class="btn btn-secondary" onclick="sendTestEmail()">Send Test Email</button>
                  <button class="btn btn-primary" onclick="saveAdminEmail()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Settings -->
          <div class="settings-panel" id="panel-payments">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Payment Configuration</h3></div>
              <div style="padding:24px;display:flex;flex-direction:column;gap:20px;">
                <div class="admin-form-group">
                  <label>Payment Gateway</label>
                  <select>
                    <option selected>Stripe</option>
                    <option>PayPal</option>
                    <option>Square</option>
                  </select>
                </div>
                <div class="admin-form-group">
                  <label>Stripe Public Key</label>
                  <input type="text" value="pk_live_••••••••••••••••••" style="font-family:monospace;font-size:12px;">
                </div>
                <div class="admin-form-group">
                  <label>Stripe Secret Key</label>
                  <input type="password" value="sk_live_••••••••••••••••••" style="font-family:monospace;font-size:12px;">
                </div>
                <hr style="border:none;border-top:1px solid var(--border-light);margin:4px 0;">
                <h4 style="font-size:14px;font-weight:600;">Commission Settings</h4>
                <div class="admin-form-row">
                  <div class="admin-form-group">
                    <label>Platform Commission (%)</label>
                    <input type="number" value="20" min="0" max="100">
                  </div>
                  <div class="admin-form-group">
                    <label>Instructor Payout (%)</label>
                    <input type="number" value="80" min="0" max="100">
                  </div>
                </div>
                <div class="admin-form-group">
                  <label>Minimum Payout Threshold</label>
                  <input type="number" value="50" placeholder="$50">
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <span style="font-size:13px;">Enable automatic payouts</span>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;padding-top:8px;">
                  <button class="btn btn-secondary" onclick="showToast('Changes discarded','info')">Cancel</button>
                  <button class="btn btn-primary" onclick="saveAdminPayments()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Security Settings -->
          <div class="settings-panel" id="panel-security">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Security Settings</h3></div>
              <div style="padding:24px;display:flex;flex-direction:column;gap:20px;">
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div>
                      <div style="font-size:13px;font-weight:500;">Two-Factor Authentication</div>
                      <div style="font-size:11px;color:var(--text-tertiary);margin-top:2px;">Require 2FA for all admin accounts</div>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div>
                      <div style="font-size:13px;font-weight:500;">Enforce Strong Passwords</div>
                      <div style="font-size:11px;color:var(--text-tertiary);margin-top:2px;">Min 8 chars, upper/lower, number, symbol</div>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-row">
                  <div class="admin-form-group">
                    <label>Session Timeout (minutes)</label>
                    <input type="number" value="30" min="5" max="1440">
                  </div>
                  <div class="admin-form-group">
                    <label>Max Login Attempts</label>
                    <input type="number" value="5" min="1" max="20">
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div>
                      <div style="font-size:13px;font-weight:500;">IP Whitelisting</div>
                      <div style="font-size:11px;color:var(--text-tertiary);margin-top:2px;">Restrict admin access to specific IPs</div>
                    </div>
                    <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div>
                      <div style="font-size:13px;font-weight:500;">Audit Logging</div>
                      <div style="font-size:11px;color:var(--text-tertiary);margin-top:2px;">Log all admin actions for compliance</div>
                    </div>
                    <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;padding-top:8px;">
                  <button class="btn btn-secondary" onclick="showToast('Changes discarded','info')">Cancel</button>
                  <button class="btn btn-primary" onclick="saveAdminSecurity()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>

          <!-- API Settings -->
          <div class="settings-panel" id="panel-api">
            <div class="card">
              <div class="card-header"><h3 class="card-title">API & Integrations</h3></div>
              <div style="padding:24px;display:flex;flex-direction:column;gap:20px;">
                <div class="admin-form-group">
                  <label>API Key</label>
                  <div style="display:flex;gap:8px;">
                    <input type="text" value="wsr_live_4f8a2c1e9d3b7f6a5e8c2d1b" style="font-family:monospace;font-size:12px;flex:1;" readonly>
                    <button class="btn btn-secondary btn-sm" onclick="copyApiKey()">Copy</button>
                    <button class="btn btn-secondary btn-sm" onclick="regenerateApiKey()">Regenerate</button>
                  </div>
                </div>
                <div class="admin-form-group">
                  <label>Webhook URL</label>
                  <input type="url" value="https://wiser.edu/api/webhooks" placeholder="https://your-domain.com/webhooks">
                </div>
                <hr style="border:none;border-top:1px solid var(--border-light);margin:4px 0;">
                <h4 style="font-size:14px;font-weight:600;">Connected Services</h4>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div style="display:flex;align-items:center;gap:10px;">
                      <span style="font-size:20px;"><span class="wi wi-mail"></span></span>
                      <div>
                        <div style="font-size:13px;font-weight:500;">Mailchimp</div>
                        <div style="font-size:11px;color:var(--text-tertiary);">Email marketing sync</div>
                      </div>
                    </div>
                    <span class="admin-status-pill active">connected</span>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div style="display:flex;align-items:center;gap:10px;">
                      <span style="font-size:20px;"><span class="wi wi-chart"></span></span>
                      <div>
                        <div style="font-size:13px;font-weight:500;">Google Analytics</div>
                        <div style="font-size:11px;color:var(--text-tertiary);">Traffic & behavior tracking</div>
                      </div>
                    </div>
                    <span class="admin-status-pill active">connected</span>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div style="display:flex;align-items:center;gap:10px;">
                      <span style="font-size:20px;"><span class="wi wi-message"></span></span>
                      <div>
                        <div style="font-size:13px;font-weight:500;">Slack</div>
                        <div style="font-size:11px;color:var(--text-tertiary);">Team notifications</div>
                      </div>
                    </div>
                    <span class="admin-status-pill pending">not connected</span>
                  </div>
                </div>
                <div class="admin-form-group">
                  <div class="settings-toggle-row">
                    <div style="display:flex;align-items:center;gap:10px;">
                      <span style="font-size:20px;"><span class="wi wi-video"></span></span>
                      <div>
                        <div style="font-size:13px;font-weight:500;">Vimeo</div>
                        <div style="font-size:11px;color:var(--text-tertiary);">Video hosting</div>
                      </div>
                    </div>
                    <span class="admin-status-pill active">connected</span>
                  </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;padding-top:8px;">
                  <button class="btn btn-primary" onclick="saveAdminApi()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast" class="admin-toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.2/dist/umd/supabase.min.js" integrity="sha384-zhtfJ1S/qkpAToBl4XpbM2NH5uZgfUq2z4qo30Ed7TxgPxmkM+L1Gm94iyexzcJ6" crossorigin="anonymous"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/admin.js"></script>
  <script>
    function switchSettingsTab(el, tab) {
      document.querySelectorAll('.settings-nav-item').forEach(a => a.classList.remove('active'));
      document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');
    }

    // Load saved settings from Supabase
    (async function loadAdminSettings() {
      try {
        const settings = await WiserAPI.admin.getSettings().catch(() => ({}));
        if (settings.platformName) document.getElementById('platformName').value = settings.platformName;
        if (settings.platformTagline) document.getElementById('platformTagline').value = settings.platformTagline;
        if (settings.supportEmail) document.getElementById('supportEmail').value = settings.supportEmail;
        if (settings.platformLang) document.getElementById('platformLang').value = settings.platformLang;
        if (settings.platformTimezone) document.getElementById('platformTimezone').value = settings.platformTimezone;
        if (settings.maintenance !== undefined) document.getElementById('maintenanceToggle').checked = settings.maintenance;

        // Toggle persistence via Supabase
        const toggleSettings = settings.toggles || {};
        document.querySelectorAll('.toggle-switch input').forEach(tog => {
          const label = tog.closest('.settings-toggle-row')?.querySelector('span, div:first-child')?.textContent?.trim()?.slice(0, 30);
          const key = (label || '').replace(/\s+/g, '_');
          if (toggleSettings[key] !== undefined) tog.checked = toggleSettings[key];
          tog.addEventListener('change', () => {
            toggleSettings[key] = tog.checked;
            WiserAPI.admin.updateSetting('toggles', toggleSettings).catch(e => console.warn(e));
          });
        });
      } catch (e) { console.warn('Admin settings load error:', e); }
    })();

    async function saveAdminGeneral() {
      const settings = {
        platformName: document.getElementById('platformName').value,
        platformTagline: document.getElementById('platformTagline').value,
        supportEmail: document.getElementById('supportEmail').value,
        platformLang: document.getElementById('platformLang').value,
        platformTimezone: document.getElementById('platformTimezone').value,
        maintenance: document.getElementById('maintenanceToggle').checked
      };
      try {
        await WiserAPI.admin.updateSetting('general', settings);
      } catch (e) { console.warn('Save error:', e); }
      showToast('General settings saved!');
    }

    async function saveAdminEmail() {
      const inputs = document.querySelectorAll('#panel-email input[type="text"], #panel-email input[type="password"], #panel-email input[type="number"]');
      const emailSettings = {};
      inputs.forEach((inp, i) => emailSettings['email_field_' + i] = inp.value);
      try {
        await WiserAPI.admin.updateSetting('email', emailSettings);
      } catch (e) { console.warn('Save error:', e); }
      showToast('Email settings saved!');
    }

    function sendTestEmail() {
      showToast('Sending test email...', 'info');
      setTimeout(() => showToast('Test email sent to admin@wiser.edu!'), 2000);
    }

    async function saveAdminPayments() {
      const inputs = document.querySelectorAll('#panel-payments input, #panel-payments select');
      const paySettings = {};
      inputs.forEach((inp, i) => paySettings['pay_' + i] = inp.value || inp.checked);
      try {
        await WiserAPI.admin.updateSetting('payments', paySettings);
      } catch (e) { console.warn('Save error:', e); }
      showToast('Payment settings saved!');
    }

    async function saveAdminSecurity() {
      const inputs = document.querySelectorAll('#panel-security input');
      const secSettings = {};
      inputs.forEach((inp, i) => secSettings['sec_' + i] = inp.type === 'checkbox' ? inp.checked : inp.value);
      try {
        await WiserAPI.admin.updateSetting('security', secSettings);
      } catch (e) { console.warn('Save error:', e); }
      showToast('Security settings saved!');
    }

    function copyApiKey() {
      const input = document.querySelector('#panel-api input[readonly]');
      navigator.clipboard.writeText(input.value).then(() => {
        showToast('API key copied to clipboard!');
      }).catch(() => {
        input.select();
        document.execCommand('copy');
        showToast('API key copied!');
      });
    }

    async function regenerateApiKey() {
      if (!confirm('Are you sure? This will invalidate the current API key.')) return;
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let newKey = 'wsr_live_';
      for (let i = 0; i < 24; i++) newKey += chars[Math.floor(Math.random() * chars.length)];
      document.querySelector('#panel-api input[readonly]').value = newKey;
      try {
        await WiserAPI.admin.updateSetting('api_key', newKey);
      } catch (e) { console.warn('API key save error:', e); }
      showToast('New API key generated!', 'warning');
    }

    async function saveAdminApi() {
      const webhook = document.querySelector('#panel-api input[type="url"]').value;
      try {
        await WiserAPI.admin.updateSetting('webhook', webhook);
      } catch (e) { console.warn('Webhook save error:', e); }
      showToast('API settings saved!');
    }
  </script>

  <style>
    .admin-settings-grid {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 24px;
    }
    .admin-settings-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: sticky;
      top: 24px;
      align-self: start;
    }
    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
    }
    .settings-nav-item:hover { background: var(--bg-secondary); color: var(--text-primary); }
    .settings-nav-item.active { background: var(--primary); color: white; }
    .settings-panel { display: none; }
    .settings-panel.active { display: block; }

    .admin-form-group { display: flex; flex-direction: column; gap: 6px; }
    .admin-form-group label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .admin-form-group input,
    .admin-form-group select,
    .admin-form-group textarea {
      padding: 10px 14px;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }
    .admin-form-group input:focus,
    .admin-form-group select:focus,
    .admin-form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(61,139,28,0.1);
    }
    .admin-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; inset: 0;
      background: #D1D5DB; border-radius: 24px;
      transition: 0.3s;
    }
    .toggle-slider::before {
      content: ''; position: absolute;
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background: white; border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }

    @media (max-width: 768px) {
      .admin-settings-grid { grid-template-columns: 1fr; }
      .admin-settings-nav { flex-direction: row; overflow-x: auto; position: static; }
      .settings-nav-item { white-space: nowrap; padding: 8px 12px; }
      .admin-form-row { grid-template-columns: 1fr; }
    }
  </style>
<script>if(typeof ThemeManager==='undefined'){var ThemeManager={toggle:function(){var c=document.documentElement.getAttribute('data-theme')||'light';var n=c==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',n);localStorage.setItem('wiser_theme',n);document.querySelectorAll('.theme-toggle').forEach(function(b){var s=b.querySelector('.icon-sun');var m=b.querySelector('.icon-moon');if(s&&m){s.style.display=n==='dark'?'block':'none';m.style.display=n==='dark'?'none':'block'}});document.querySelectorAll('.logo-light').forEach(function(e){e.style.display=n==='dark'?'none':'block'});document.querySelectorAll('.logo-dark').forEach(function(e){e.style.display=n==='dark'?'block':'none'})}}}</script>
</body>
</html>
