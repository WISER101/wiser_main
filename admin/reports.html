<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports â€” Admin â€” Wiser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/admin.css">
  <script>(function(){var t=localStorage.getItem('wiser_theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark')})()</script>
</head>
<body>
  <div class="app-layout">
    <!-- Admin Sidebar -->
    <aside class="sidebar admin-sidebar">
      <div class="sidebar-logo">
        <a href="dashboard.html">
          <img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-icon logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-icon logo-dark">
        </a>
        <span class="admin-badge">Admin</span>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-nav-label">Overview</div>
        <a href="dashboard.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          Dashboard
        </a>
        <a href="users.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Users
        </a>
        <div class="sidebar-nav-label">Content</div>
        <a href="courses.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          Courses
        </a>
        <a href="reports.html" class="sidebar-link active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Reports
        </a>
        <div class="sidebar-nav-label">Finance</div>
        <a href="revenue.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Revenue
        </a>
        <div class="sidebar-nav-label">System</div>
        <a href="settings.html" class="sidebar-link">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </a>
      </nav>
      <div class="sidebar-user">
        <div class="avatar avatar-sm" style="background: linear-gradient(135deg, #DC2626, #5ab82e)">A</div>
        <div class="sidebar-user-info">
          <span class="sidebar-user-name">Admin</span>
          <span class="sidebar-user-role">Super Admin</span>
        </div>
      </div>
    </aside>

    <div class="sidebar-overlay" onclick="document.body.classList.remove('sidebar-open')"></div>

    <main class="main-content">
      <header class="top-header">
        <button class="sidebar-toggle" onclick="document.body.classList.toggle('sidebar-open')">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <h2 class="page-title">Reports & Analytics</h2>
        <div style="flex:1"></div>
        <div class="header-actions">
          <button class="theme-toggle" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode" style="background:none;border:none;cursor:pointer;padding:6px;"><svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
          <select id="reportRange" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border-light);font-size:13px;background:var(--bg-primary);">
            <option>Last 7 Days</option>
            <option selected>Last 30 Days</option>
            <option>Last 90 Days</option>
            <option>This Year</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="exportReportPDF()"><span class="wi wi-file"></span> Export</button>
        </div>
      </header>

      <div class="page-content">
      <!-- KPI Cards -->
      <div class="admin-stats-grid">
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="background:rgba(61,139,28,0.1);color:#3d8b1c;"><span class="wi wi-users"></span></div>
          <div class="admin-stat-value" data-count="6842" data-prefix="">0</div>
          <div class="admin-stat-label">New Registrations</div>
          <div class="admin-stat-trend up">+18% vs prior</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="background:rgba(90,184,46,0.1);color:#5ab82e;"><span class="wi wi-grad"></span></div>
          <div class="admin-stat-value" data-count="3219">0</div>
          <div class="admin-stat-label">Course Completions</div>
          <div class="admin-stat-trend up">+12% vs prior</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="background:rgba(159,232,112,0.1);color:#9fe870;"><span class="wi wi-stopwatch"></span></div>
          <div class="admin-stat-value" data-count="42">0</div>
          <div class="admin-stat-label">Avg. Session (min)</div>
          <div class="admin-stat-trend down">-3% vs prior</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-icon" style="background:rgba(194,65,12,0.1);color:#1e4a0d;"><span class="wi wi-star"></span></div>
          <div class="admin-stat-value" data-count="4" data-suffix=".7">0</div>
          <div class="admin-stat-label">Avg. Course Rating</div>
          <div class="admin-stat-trend up">+0.2 vs prior</div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="admin-grid-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Enrollment Trends</h3>
          </div>
          <div class="admin-chart-container">
            <canvas id="enrollmentChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Completion Rate</h3>
          </div>
          <div class="admin-chart-container">
            <canvas id="completionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Popular Content & Demographics -->
      <div class="admin-grid-2">
        <!-- Top Categories -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Top Categories</h3>
          </div>
          <div style="padding:20px;" id="categoriesBreakdown"></div>
        </div>

        <!-- Geographic Distribution -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">User Demographics</h3>
          </div>
          <div style="padding:20px;" id="demographicsBreakdown"></div>
        </div>
      </div>

      <!-- Engagement Table -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Course Engagement Report</h3>
        </div>
        <div class="admin-table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Course</th>
              <th>Enrolled</th>
              <th>Active</th>
              <th>Completed</th>
              <th>Completion %</th>
              <th>Avg. Score</th>
              <th>Avg. Time</th>
            </tr>
          </thead>
          <tbody id="engagementTable"></tbody>
        </table>
        </div>
      </div>
      </div>
    </main>
  </div>

  <div id="toast" class="admin-toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.2/dist/umd/supabase.min.js" integrity="sha384-zhtfJ1S/qkpAToBl4XpbM2NH5uZgfUq2z4qo30Ed7TxgPxmkM+L1Gm94iyexzcJ6" crossorigin="anonymous"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/admin.js"></script>
  <script>
    // ---- Enrollment Chart ----
    (function() {
      const canvas = document.getElementById('enrollmentChart');
      if (!canvas) return;
      function draw() {
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * 2; canvas.height = rect.height * 2;
        canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
        ctx.scale(2,2);
        const w = rect.width, h = rect.height;
        const pad = { top:20, right:20, bottom:40, left:50 };
        const data = [420, 510, 480, 620, 580, 710, 690, 820, 760, 880, 950, 1020, 920, 1100];
        const maxVal = Math.max(...data) * 1.15;
        const chartW = w - pad.left - pad.right;
        const chartH = h - pad.top - pad.bottom;

        // Grid
        for (let i = 0; i <= 4; i++) {
          const y = pad.top + (chartH/4)*i;
          ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w-pad.right, y); ctx.stroke();
          ctx.fillStyle = '#9CA3AF'; ctx.font = '11px Inter, sans-serif'; ctx.textAlign = 'right';
          ctx.fillText(Math.round(maxVal - (maxVal/4)*i), pad.left - 8, y + 4);
        }

        // Bars
        const barW = chartW / data.length * 0.6;
        data.forEach((val, i) => {
          const x = pad.left + (chartW/data.length) * i + (chartW/data.length - barW)/2;
          const barH = (val/maxVal) * chartH;
          const grad = ctx.createLinearGradient(0, pad.top+chartH-barH, 0, pad.top+chartH);
          grad.addColorStop(0, '#3d8b1c'); grad.addColorStop(1, '#7ad44a');
          ctx.fillStyle = grad;
          ctx.beginPath(); ctx.roundRect(x, pad.top+chartH-barH, barW, barH, [4,4,0,0]); ctx.fill();
        });

        // X labels
        const weeks = data.map((_,i) => 'W'+(i+1));
        ctx.fillStyle = '#9CA3AF'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'center';
        weeks.forEach((label, i) => {
          const x = pad.left + (chartW/data.length) * i + chartW/data.length/2;
          ctx.fillText(label, x, h - pad.bottom + 18);
        });
      }
      setTimeout(draw, 100);
      window.addEventListener('resize', draw);
    })();

    // ---- Completion Chart ----
    (function() {
      const canvas = document.getElementById('completionChart');
      if (!canvas) return;
      function draw() {
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * 2; canvas.height = rect.height * 2;
        canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
        ctx.scale(2,2);
        const w = rect.width, h = rect.height;
        const pad = { top:20, right:20, bottom:40, left:50 };
        const data = [58, 62, 59, 65, 68, 64, 72, 70, 75, 73, 78, 76, 81, 79];
        const maxVal = 100;
        const chartW = w - pad.left - pad.right;
        const chartH = h - pad.top - pad.bottom;

        // Grid
        for (let i = 0; i <= 4; i++) {
          const y = pad.top + (chartH/4)*i;
          ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w-pad.right, y); ctx.stroke();
          ctx.fillStyle = '#9CA3AF'; ctx.font = '11px Inter, sans-serif'; ctx.textAlign = 'right';
          ctx.fillText(Math.round(100 - (100/4)*i) + '%', pad.left - 8, y + 4);
        }

        // Area
        const gradient = ctx.createLinearGradient(0, pad.top, 0, h - pad.bottom);
        gradient.addColorStop(0, 'rgba(90,184,46,0.15)'); gradient.addColorStop(1, 'rgba(90,184,46,0.01)');
        ctx.beginPath();
        data.forEach((val, i) => {
          const x = pad.left + (chartW/(data.length-1)) * i;
          const y = pad.top + chartH - (val/maxVal) * chartH;
          if (i === 0) ctx.moveTo(x, y);
          else {
            const px = pad.left + (chartW/(data.length-1))*(i-1);
            const py = pad.top + chartH - (data[i-1]/maxVal)*chartH;
            ctx.bezierCurveTo((px+x)/2, py, (px+x)/2, y, x, y);
          }
        });
        ctx.lineTo(pad.left + chartW, pad.top + chartH);
        ctx.lineTo(pad.left, pad.top + chartH);
        ctx.closePath(); ctx.fillStyle = gradient; ctx.fill();

        // Line
        ctx.beginPath();
        data.forEach((val, i) => {
          const x = pad.left + (chartW/(data.length-1)) * i;
          const y = pad.top + chartH - (val/maxVal) * chartH;
          if (i === 0) ctx.moveTo(x, y);
          else {
            const px = pad.left + (chartW/(data.length-1))*(i-1);
            const py = pad.top + chartH - (data[i-1]/maxVal)*chartH;
            ctx.bezierCurveTo((px+x)/2, py, (px+x)/2, y, x, y);
          }
        });
        ctx.strokeStyle = '#5ab82e'; ctx.lineWidth = 2.5; ctx.stroke();

        // X labels
        ctx.fillStyle = '#9CA3AF'; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'center';
        data.forEach((_, i) => {
          const x = pad.left + (chartW/(data.length-1))*i;
          if (i % 2 === 0) ctx.fillText('W'+(i+1), x, h - pad.bottom + 18);
        });
      }
      setTimeout(draw, 100);
      window.addEventListener('resize', draw);
    })();

    // ---- Top Categories Breakdown ----
    (function() {
      const el = document.getElementById('categoriesBreakdown');
      if (!el) return;
      const categories = [
        { name: 'Development', pct: 38, color: '#3d8b1c', courses: 487 },
        { name: 'Data Science', pct: 24, color: '#5ab82e', courses: 308 },
        { name: 'Design', pct: 18, color: '#1e4a0d', courses: 231 },
        { name: 'Business', pct: 12, color: '#9fe870', courses: 154 },
        { name: 'Marketing', pct: 8, color: '#9fe870', courses: 104 },
      ];
      el.innerHTML = categories.map(c => `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <div style="width:10px;height:10px;border-radius:50%;background:${c.color};flex-shrink:0;"></div>
          <div style="flex:1;min-width:0;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span style="font-weight:500;font-size:13px;">${c.name}</span>
              <span style="font-size:12px;color:var(--text-tertiary);">${c.courses} courses</span>
            </div>
            <div style="height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;">
              <div style="height:100%;width:${c.pct}%;background:${c.color};border-radius:3px;transition:width 1s ease;"></div>
            </div>
          </div>
          <span style="font-weight:600;font-size:13px;width:40px;text-align:right;">${c.pct}%</span>
        </div>
      `).join('');
    })();

    // ---- Demographics ----
    (function() {
      const el = document.getElementById('demographicsBreakdown');
      if (!el) return;
      const countries = [
        { name: 'United States', flag: 'ðŸ‡ºðŸ‡¸', pct: 32, users: '16,911' },
        { name: 'India', flag: 'ðŸ‡®ðŸ‡³', pct: 21, users: '11,098' },
        { name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§', pct: 14, users: '7,398' },
        { name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·', pct: 9, users: '4,756' },
        { name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª', pct: 7, users: '3,699' },
        { name: 'Others', flag: '<span class="wi wi-globe"></span>', pct: 17, users: '8,985' },
      ];
      el.innerHTML = countries.map(c => `
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-light);">
          <span style="font-size:20px;">${c.flag}</span>
          <div style="flex:1;">
            <span style="font-weight:500;font-size:13px;">${c.name}</span>
          </div>
          <span style="font-size:12px;color:var(--text-tertiary);">${c.users}</span>
          <span style="font-weight:600;font-size:13px;width:40px;text-align:right;">${c.pct}%</span>
        </div>
      `).join('');
    })();

    // ---- Engagement Table ----
    (function() {
      const tbody = document.getElementById('engagementTable');
      if (!tbody) return;
      const rows = [
        { name: 'Advanced React Masterclass', enrolled: 4281, active: 2841, completed: 1892, score: 87, time: '14h 20m' },
        { name: 'Python for Data Science', enrolled: 3941, active: 2610, completed: 1644, score: 84, time: '18h 45m' },
        { name: 'UI/UX Design Bootcamp', enrolled: 3122, active: 1980, completed: 1412, score: 91, time: '12h 10m' },
        { name: 'Full-Stack JavaScript', enrolled: 2847, active: 1920, completed: 1310, score: 82, time: '22h 05m' },
        { name: 'Machine Learning A-Z', enrolled: 2561, active: 1650, completed: 980, score: 79, time: '26h 30m' },
        { name: 'Digital Marketing Strategy', enrolled: 1823, active: 1120, completed: 890, score: 88, time: '8h 40m' },
        { name: 'Cloud Architecture', enrolled: 1245, active: 820, completed: 510, score: 76, time: '20h 15m' },
      ];
      tbody.innerHTML = rows.map(r => {
        const pct = Math.round(r.completed / r.enrolled * 100);
        const pctColor = pct >= 60 ? '#5ab82e' : pct >= 40 ? '#9fe870' : '#EF4444';
        return `
          <tr>
            <td style="font-weight:500;">${r.name}</td>
            <td>${r.enrolled.toLocaleString()}</td>
            <td>${r.active.toLocaleString()}</td>
            <td>${r.completed.toLocaleString()}</td>
            <td><span style="color:${pctColor};font-weight:600;">${pct}%</span></td>
            <td>${r.score}/100</td>
            <td style="color:var(--text-tertiary);">${r.time}</td>
          </tr>
        `;
      }).join('');
    })();

    function exportReportPDF() {
      const headers = ['Course','Enrolled','Active','Completed','Completion %','Avg Score','Avg Time'];
      const rows = [
        ['Advanced React Masterclass','4281','2841','1892','44%','87','14h 20m'],
        ['Python for Data Science','3941','2610','1644','42%','84','18h 45m'],
        ['UI/UX Design Bootcamp','3122','1980','1412','45%','91','12h 10m'],
        ['Full-Stack JavaScript','2847','1920','1310','46%','82','22h 05m'],
        ['Machine Learning A-Z','2561','1650','980','38%','79','26h 30m'],
        ['Digital Marketing Strategy','1823','1120','890','49%','88','8h 40m'],
        ['Cloud Architecture','1245','820','510','41%','76','20h 15m'],
      ];
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'wiser-engagement-report-' + new Date().toISOString().slice(0,10) + '.csv';
      a.click(); URL.revokeObjectURL(url);
      showToast('Report exported!');
    }
  </script>
<script>if(typeof ThemeManager==='undefined'){var ThemeManager={toggle:function(){var c=document.documentElement.getAttribute('data-theme')||'light';var n=c==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',n);localStorage.setItem('wiser_theme',n);document.querySelectorAll('.theme-toggle').forEach(function(b){var s=b.querySelector('.icon-sun');var m=b.querySelector('.icon-moon');if(s&&m){s.style.display=n==='dark'?'block':'none';m.style.display=n==='dark'?'none':'block'}});document.querySelectorAll('.logo-light').forEach(function(e){e.style.display=n==='dark'?'none':'block'});document.querySelectorAll('.logo-dark').forEach(function(e){e.style.display=n==='dark'?'block':'none'})}}}</script>
</body>
</html>
