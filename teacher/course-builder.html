<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Builder — Wiser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/teacher.css">
  <script>(function(){var t=localStorage.getItem('wiser_theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark')})()</script>
</head>
<body>
<div class="teacher-page">

  <!-- ========== TOP NAVBAR ========== -->
  <nav class="teacher-topbar">
    <div class="teacher-topbar-inner">
      <a href="../index.html" class="teacher-topbar-logo"><img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-dark"></a>
      <div class="teacher-topbar-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="schools.html">Schools</a>
        <a href="creator-hub.html">My Courses</a>
        <a href="analytics.html">Analytics</a>
        <a href="community.html">Community</a>
        <a href="payout.html">Payout</a>
      </div>
      <div class="teacher-topbar-actions">
        <button class="theme-toggle" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode" ><svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
        <button class="stu-notif-btn" onclick="document.querySelector('.stu-notif-panel').classList.toggle('active');document.querySelector('.stu-notif-backdrop').classList.toggle('active')" ><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="stu-notif-badge">2</span></button>
        <a href="course-builder.html" class="btn btn-primary btn-sm">Create a New Course &rarr;</a>
        <button class="teacher-topbar-toggle" onclick="document.querySelector('.teacher-mobile-menu').classList.toggle('active');document.querySelector('.teacher-mobile-overlay').classList.toggle('active')" aria-label="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Teacher Mobile Menu -->
  <div class="teacher-mobile-overlay" onclick="this.classList.remove('active');document.querySelector('.teacher-mobile-menu').classList.remove('active')"></div>
  <div class="teacher-mobile-menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="schools.html">Schools</a>
    <a href="creator-hub.html">My Courses</a>
    <a href="analytics.html">Analytics</a>
    <a href="community.html">Community</a>
    <a href="payout.html">Payout</a>
    <a href="settings.html">Settings</a>
    <a href="course-builder.html">Create a New Course</a>
  </div>

  <!-- Notification Panel -->
  <div class="stu-notif-backdrop" onclick="this.classList.remove('active');document.querySelector('.stu-notif-panel').classList.remove('active')"></div>
  <div class="stu-notif-panel">
    <div class="stu-notif-panel-header"><h3 style="font-size:16px;font-weight:700;">Notifications</h3><button class="stu-notif-mark-all" onclick="document.querySelectorAll('.stu-notif-item').forEach(i=>i.classList.remove('unread'));this.style.display='none';document.querySelector('.stu-notif-badge').style.display='none';">Mark all read</button></div>
    <div class="stu-notif-list" id="notifList"></div>
  </div>

  <!-- ========== COVER BANNER ========== -->
  <div class="teacher-cover-banner">
    <div class="teacher-cover-content">
      <div class="teacher-cover-label">Bootcamp Instructor</div>
      <h1 class="teacher-cover-name">Learn With Us</h1>
    </div>
  </div>
  <div class="teacher-profile-bar">
    <div class="teacher-profile-avatar"><img src="../assets/Teacher-Student/1.png" alt="Instructor"></div>
    <div class="teacher-profile-info"><div class="teacher-profile-info-name">Instructor</div><div class="teacher-profile-rating"><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span> <span style="color:rgba(255,255,255,0.7);margin-left:4px">(35 Reviews)</span></div></div>
    <div class="teacher-profile-cta"><a href="course-builder.html" class="btn">Create a New Course &rarr;</a></div>
  </div>

  <!-- ========== MAIN BODY ========== -->
  <div class="teacher-body">
    <!-- Left Sidebar Navigation -->
    <aside class="teacher-sidebar-card">
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">Welcome, Instructor</div>
        <a href="dashboard.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</a>
        <a href="schools.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Schools</a>
        <a href="analytics.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Analytics</a>
        <a href="payout.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Payout</a>
      </div>
      <div class="teacher-sidebar-divider"></div>
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">Instructor</div>
        <a href="creator-hub.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> My Courses</a>
        <a href="course-builder.html" class="teacher-nav-link active"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> Course Builder</a>
        <a href="community.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Community</a>
        <a href="store-manager.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg> Store Manager</a>
      </div>
      <div class="teacher-sidebar-divider"></div>
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">User</div>
        <a href="settings.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> Settings</a>
        <a href="../auth/login.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> Logout</a>
      </div>
    </aside>

    <!-- Right Content Area -->
    <div class="teacher-content">
      <div class="teacher-builder-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-5);flex-wrap:wrap;gap:12px">
        <h2 class="teacher-content-title" style="margin-bottom:0">Course Builder</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-secondary btn-sm" onclick="previewCourse()">&#128065; Preview Course</button>
          <button class="btn btn-secondary btn-sm" onclick="saveDraft()">Save Draft</button>
          <button class="btn btn-primary btn-sm" onclick="publishCourse()">Publish Course</button>
        </div>
      </div>

      <!-- Builder 2-column layout -->
      <div class="tg-2">
        <!-- Left: Course Details Form -->
        <div>
          <div class="teacher-card" style="margin-bottom:var(--space-5)">
            <h3 style="margin-bottom:var(--space-4)">Course Details</h3>
            <div style="margin-bottom:var(--space-4)">
              <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Course Title</label>
              <input id="cbTitle" type="text" class="form-input" value="Complete Web Development Bootcamp" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm)">
            </div>
            <div style="margin-bottom:var(--space-4)">
              <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Description</label>
              <textarea id="cbDescription" class="form-input" rows="4" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm);resize:vertical">Master HTML, CSS, JavaScript, React, Node.js and more. Build real-world projects from scratch.</textarea>
            </div>
            <div class="tg-form-row mb-4">
              <div>
                <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Category</label>
                <select id="cbCategory" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm);background:var(--bg-primary);color:var(--text-primary)">
                </select>
              </div>
              <div>
                <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Level</label>
                <select id="cbLevel" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm);background:var(--bg-primary);color:var(--text-primary)">
                </select>
              </div>
            </div>
            <div class="tg-form-row mb-4">
              <div>
                <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Price ($)</label>
                <input id="cbPrice" type="number" class="form-input" value="89.99" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm)">
              </div>
              <div>
                <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Original Price ($)</label>
                <input id="cbOriginalPrice" type="number" class="form-input" value="199.99" style="width:100%;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm)">
              </div>
            </div>
            <div style="margin-bottom:var(--space-4)">
              <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Course Thumbnail</label>
              <label style="border:2px dashed var(--border-light);border-radius:var(--radius-lg);padding:var(--space-6);text-align:center;cursor:pointer;background:var(--bg-secondary);display:block" id="thumbDropZone">
                <input type="file" accept="image/*" style="display:none" id="thumbInput" onchange="handleThumbUpload(this)">
                <div id="thumbPreview">
                  <div style="font-size:var(--text-2xl);margin-bottom:8px"><span class="wi wi-video"></span></div>
                  <p style="font-size:var(--text-sm);color:var(--text-tertiary)">Click to upload or drag and drop<br><span style="font-size:var(--text-xs)">PNG, JPG up to 5MB</span></p>
                </div>
              </label>
            </div>
            <div>
              <label style="display:block;font-size:var(--text-sm);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Tags</label>
              <div style="display:flex;flex-wrap:wrap;gap:8px">
                <span style="background:var(--primary-50);color:var(--primary-600);padding:4px 12px;border-radius:999px;font-size:var(--text-xs);font-weight:600;cursor:pointer" onclick="removeTag(this)">HTML &times;</span>
                <span style="background:var(--primary-50);color:var(--primary-600);padding:4px 12px;border-radius:999px;font-size:var(--text-xs);font-weight:600;cursor:pointer" onclick="removeTag(this)">CSS &times;</span>
                <span style="background:var(--primary-50);color:var(--primary-600);padding:4px 12px;border-radius:999px;font-size:var(--text-xs);font-weight:600;cursor:pointer" onclick="removeTag(this)">JavaScript &times;</span>
                <span style="background:var(--primary-50);color:var(--primary-600);padding:4px 12px;border-radius:999px;font-size:var(--text-xs);font-weight:600;cursor:pointer" onclick="removeTag(this)">React &times;</span>
                <input type="text" id="tagInput" placeholder="Add tag..." style="border:none;outline:none;font-size:var(--text-xs);width:100px;background:transparent" onkeydown="if(event.key==='Enter'){addTag(this)}">
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Curriculum Builder -->
        <div>
          <div class="teacher-card" style="margin-bottom:var(--space-4)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-4)">
              <h3>Curriculum</h3>
              <button class="btn btn-primary btn-sm" onclick="addSection()">+ Add Section</button>
            </div>
            <div id="curriculumBuilder"></div>
          </div>

          <!-- AI Assist Card -->
          <div class="teacher-card" style="background:linear-gradient(135deg, rgba(61,139,28,0.05), rgba(159,232,112,0.05));border:1px solid rgba(61,139,28,0.15)">
            <div style="display:flex;gap:12px;align-items:flex-start">
              <div style="font-size:var(--text-2xl)"><span class="wi wi-zap"></span></div>
              <div>
                <h4 style="color:var(--primary-600);margin-bottom:4px">AI Course Assistant</h4>
                <p style="font-size:var(--text-sm);color:var(--text-secondary);margin-bottom:12px">Generate a complete curriculum outline using AI. Just describe your course topic.</p>
                <div style="display:flex;gap:8px">
                  <input id="aiTopicInput" type="text" class="form-input" placeholder="e.g., Advanced TypeScript patterns..." style="flex:1;padding:8px 12px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm)">
                  <button class="btn btn-primary btn-sm" onclick="aiGenerateCurriculum()">Generate</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== FOOTER ========== -->
  <footer class="teacher-footer">
    <div class="teacher-footer-inner">
      <div class="teacher-footer-grid">
        <div><div class="teacher-footer-brand"><img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-dark"><span>Wiser</span></div><p class="teacher-footer-desc">We're always in search for talented and motivated people.</p><div class="teacher-footer-socials"><a href="#" class="teacher-footer-social-icon">f</a><a href="#" class="teacher-footer-social-icon">t</a><a href="#" class="teacher-footer-social-icon">in</a><a href="#" class="teacher-footer-social-icon">ig</a></div></div>
        <div><h4>Useful Links</h4><div class="teacher-footer-links"><a href="#">Marketplace</a><a href="#">Courses</a><a href="#">Community</a><a href="#">FAQ</a><a href="#">About Us</a></div></div>
        <div><h4>Our Company</h4><div class="teacher-footer-links"><a href="#">Contact Us</a><a href="schools.html">Invite Teachers</a><a href="#">Blog</a><a href="#">Events</a><a href="#">Careers</a></div></div>
        <div><h4>Get in Touch</h4><p style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-2)">Phone: (406) 555-0120<br>Email: admin@wiser.com</p><div class="teacher-footer-newsletter-form"><input type="email" placeholder="Enter Your Email Here"><button>Submit Now</button></div></div>
      </div>
      <div class="teacher-footer-bottom"><span>Copyright &copy; 2026 <strong>Wiser</strong>. All Rights Reserved</span><div class="teacher-footer-bottom-links"><a href="#">Terms of Service</a><a href="#">Privacy Policy</a><a href="../auth/login.html">Login &amp; Register</a></div></div>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.2/dist/umd/supabase.min.js" integrity="sha384-zhtfJ1S/qkpAToBl4XpbM2NH5uZgfUq2z4qo30Ed7TxgPxmkM+L1Gm94iyexzcJ6" crossorigin="anonymous"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
<script src="../js/app.js"></script>
<script>
  let _curriculum = [];
  let _courseId = null;

  document.addEventListener('DOMContentLoaded', async () => {
    // Auth guard — server-side role verification
    const __authProfile = await WiserAuth.requireAuth(['teacher', 'admin']);
    if (!__authProfile) return;

    // Load profile and update UI
    try {
      const profile = await WiserAPI.profiles.getCurrent();
      if (profile) {
        const firstName = profile.first_name || profile.display_name || 'Instructor';
        const displayName = profile.display_name || ((profile.first_name || '') + ' ' + (profile.last_name || '')).trim() || 'Instructor';
        const coverNameEl = document.querySelector('.teacher-cover-name');
        if (coverNameEl) coverNameEl.textContent = 'Learn With ' + firstName;
        const profileNameEl = document.querySelector('.teacher-profile-info-name');
        if (profileNameEl) profileNameEl.textContent = displayName;
        document.querySelectorAll('.teacher-sidebar-label').forEach(el => {
          if (el.textContent.includes('Welcome,')) el.textContent = 'Welcome, ' + displayName;
        });
        const cbAvatar = document.querySelector('.teacher-profile-avatar img');
        if (cbAvatar && profile.avatar_url) cbAvatar.src = profile.avatar_url;
        const cbCoverBanner = document.querySelector('.teacher-cover-banner');
        if (cbCoverBanner && profile.cover_photo_url) { cbCoverBanner.style.backgroundImage = 'url(' + profile.cover_photo_url + ')'; cbCoverBanner.style.backgroundSize = 'cover'; }
      }
    } catch (e) { console.warn('Could not load profile:', e); }

    // Load curriculum
    const params = new URLSearchParams(window.location.search);
    _courseId = params.get('courseId');
    if (_courseId) {
      _curriculum = await WiserData.getCurriculum(_courseId).catch(() => []) || [];
    } else {
      // Load default structure for new course
      _curriculum = [{ title: 'Getting Started', lessons: [] }];
    }

    renderCurriculum();
    initThumbUpload();
  });

  /* ====== CURRICULUM RENDERING ====== */
  function renderCurriculum() {
    const el = document.getElementById('curriculumBuilder');
    el.innerHTML = _curriculum.map((section, si) => {
      const lessonCount = section.lessons.length;
      return `
      <div class="builder-section" data-section="${si}" style="border:1px solid var(--border-light);border-radius:var(--radius-lg);margin-bottom:var(--space-4);overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border-light)">
          <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
            <span style="color:var(--text-tertiary);font-size:14px;cursor:grab" class="drag-handle">⠿</span>
            <input type="text" value="${section.title}" onchange="updateSectionTitle(${si}, this.value)" style="font-weight:700;font-size:var(--text-sm);border:1px solid transparent;background:transparent;padding:4px 8px;border-radius:var(--radius-md);flex:1;min-width:0;outline:none;transition:border .2s" onfocus="this.style.borderColor='var(--primary-400)';this.style.background='var(--bg-primary)'" onblur="this.style.borderColor='transparent';this.style.background='transparent'">
            <span class="teacher-badge" style="background:var(--bg-tertiary);color:var(--text-tertiary);white-space:nowrap">${lessonCount} lesson${lessonCount !== 1 ? 's' : ''}</span>
          </div>
          <div style="display:flex;gap:6px;margin-left:8px">
            <button class="btn btn-ghost btn-sm" onclick="addLesson(${si})" style="font-size:12px" title="Add lesson">+ Lesson</button>
            <button class="btn btn-ghost btn-sm" onclick="toggleSection(this)" style="font-size:12px" title="Collapse">▼</button>
            <button class="btn btn-ghost btn-sm" onclick="deleteSection(${si})" style="font-size:12px;color:#EF4444" title="Delete section">✕</button>
          </div>
        </div>
        <div class="section-lessons" style="padding:8px" data-section="${si}">
          ${section.lessons.map((lesson, li) => renderLesson(lesson, si, li)).join('')}
          ${lessonCount === 0 ? '<p style="text-align:center;padding:20px;color:var(--text-tertiary);font-size:var(--text-sm)">No lessons yet. Click "+ Lesson" to add one.</p>' : ''}
        </div>
      </div>`;
    }).join('');

    // Init drag-and-drop for lessons
    initLessonDragDrop();
  }

  function renderLesson(lesson, si, li) {
    const types = ['video', 'quiz', 'assignment', 'resource'];
    const typeIcons = { video: '<span class="wi wi-video"></span>', quiz: '<span class="wi wi-edit"></span>', assignment: '<span class="wi wi-clipboard"></span>', resource: '<span class="wi wi-file"></span>' };
    const typeIcon = typeIcons[lesson.type] || '<span class="wi wi-file"></span>';

    // Type-specific expand button
    let expandBtn = '';
    if (lesson.type === 'video') {
      expandBtn = `<button onclick="toggleLessonPanel('videoUpload-${si}-${li}')" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:var(--text-tertiary);padding:4px;border-radius:4px" title="Video settings" onmouseenter="this.style.color='var(--primary-600)'" onmouseleave="this.style.color='var(--text-tertiary)'"><span class="wi wi-wrench"></span></button>`;
    } else if (lesson.type === 'quiz') {
      expandBtn = `<button onclick="toggleLessonPanel('quizBuilder-${si}-${li}')" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:var(--text-tertiary);padding:4px;border-radius:4px" title="Quiz builder" onmouseenter="this.style.color='var(--primary-600)'" onmouseleave="this.style.color='var(--text-tertiary)'"><span class="wi wi-pencil"></span></button>`;
    }

    // Video upload panel
    let extraContent = '';
    if (lesson.type === 'video') {
      extraContent = `
      <div id="videoUpload-${si}-${li}" style="display:none;padding:4px 12px 10px 40px">
        <div style="border:1px solid var(--border-light);border-radius:var(--radius-md);padding:12px;background:var(--bg-secondary)">
          <label style="display:block;font-size:var(--text-xs);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">Video Source</label>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input type="url" placeholder="Paste video URL (YouTube, Vimeo, etc.)" value="${lesson.videoUrl || ''}" onchange="updateLessonVideoUrl(${si},${li},this.value)" style="flex:1;padding:8px 10px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-xs)">
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:var(--text-xs);color:var(--text-tertiary)">or</span>
            <label style="cursor:pointer;padding:6px 12px;border:1px dashed var(--border-light);border-radius:var(--radius-md);font-size:var(--text-xs);color:var(--primary-600);font-weight:600">
              <span class="wi wi-file"></span> Upload File
              <input type="file" accept="video/*" style="display:none" onchange="handleLessonVideoFile(${si},${li},this)">
            </label>
            <span id="videoFileName-${si}-${li}" style="font-size:var(--text-xs);color:var(--text-tertiary)">${lesson.videoFileName || ''}</span>
          </div>
        </div>
      </div>`;
    }

    // Quiz builder panel
    if (lesson.type === 'quiz') {
      const questions = lesson.questions || [];
      extraContent = `
      <div id="quizBuilder-${si}-${li}" style="display:none;padding:4px 12px 10px 40px">
        <div style="border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:16px;background:var(--bg-secondary)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h4 style="font-size:var(--text-sm);font-weight:700;color:var(--text-primary)"><span class="wi wi-edit"></span> Quiz Questions (${questions.length})</h4>
          </div>
          <div id="quizQuestions-${si}-${li}">
            ${questions.map((q, qi) => renderQuizQuestion(q, qi, si, li)).join('')}
          </div>
          <div style="border:1px solid var(--border-light);border-radius:var(--radius-md);padding:12px;background:var(--bg-primary);margin-top:8px">
            <label style="display:block;font-size:var(--text-xs);font-weight:600;margin-bottom:6px;color:var(--text-secondary)">New Question</label>
            <input type="text" id="quizQ-${si}-${li}" placeholder="Enter your question..." style="width:100%;padding:8px 10px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm);margin-bottom:10px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
              <div style="display:flex;align-items:center;gap:6px"><input type="radio" name="quizCorrect-${si}-${li}" value="A" id="quizR-${si}-${li}-A" checked><label for="quizR-${si}-${li}-A" style="font-size:var(--text-xs);font-weight:700;color:var(--text-secondary);min-width:14px">A</label><input type="text" id="quizO-${si}-${li}-A" placeholder="Option A" style="flex:1;padding:6px 8px;border:1px solid var(--border-light);border-radius:var(--radius-sm);font-size:var(--text-xs)"></div>
              <div style="display:flex;align-items:center;gap:6px"><input type="radio" name="quizCorrect-${si}-${li}" value="B" id="quizR-${si}-${li}-B"><label for="quizR-${si}-${li}-B" style="font-size:var(--text-xs);font-weight:700;color:var(--text-secondary);min-width:14px">B</label><input type="text" id="quizO-${si}-${li}-B" placeholder="Option B" style="flex:1;padding:6px 8px;border:1px solid var(--border-light);border-radius:var(--radius-sm);font-size:var(--text-xs)"></div>
              <div style="display:flex;align-items:center;gap:6px"><input type="radio" name="quizCorrect-${si}-${li}" value="C" id="quizR-${si}-${li}-C"><label for="quizR-${si}-${li}-C" style="font-size:var(--text-xs);font-weight:700;color:var(--text-secondary);min-width:14px">C</label><input type="text" id="quizO-${si}-${li}-C" placeholder="Option C" style="flex:1;padding:6px 8px;border:1px solid var(--border-light);border-radius:var(--radius-sm);font-size:var(--text-xs)"></div>
              <div style="display:flex;align-items:center;gap:6px"><input type="radio" name="quizCorrect-${si}-${li}" value="D" id="quizR-${si}-${li}-D"><label for="quizR-${si}-${li}-D" style="font-size:var(--text-xs);font-weight:700;color:var(--text-secondary);min-width:14px">D</label><input type="text" id="quizO-${si}-${li}-D" placeholder="Option D" style="flex:1;padding:6px 8px;border:1px solid var(--border-light);border-radius:var(--radius-sm);font-size:var(--text-xs)"></div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="addQuizQuestion(${si},${li})" style="font-size:12px">+ Add Question</button>
          </div>
        </div>
      </div>`;
    }

    return `
    <div class="lesson-wrapper" data-section="${si}" data-lesson="${li}">
      <div class="lesson-item" draggable="true" data-section="${si}" data-lesson="${li}" style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--radius-md);margin-bottom:2px;background:${lesson.active ? 'var(--primary-50)' : 'transparent'};transition:background .15s" onmouseenter="this.style.background=this.style.background||'var(--surface-hover)'" onmouseleave="this.style.background='${lesson.active ? 'var(--primary-50)' : 'transparent'}'">
        <span style="cursor:grab;color:var(--text-tertiary);font-size:12px" class="lesson-drag-handle">⠿</span>
        
        <!-- Type selector -->
        <select onchange="updateLessonType(${si}, ${li}, this.value)" style="border:none;background:transparent;font-size:16px;cursor:pointer;padding:0;width:28px;appearance:none;-webkit-appearance:none;text-align:center" title="Change lesson type">
          ${types.map(t => `<option value="${t}" ${lesson.type === t ? 'selected' : ''}>${typeIcons[t]}</option>`).join('')}
        </select>

        <!-- Editable title -->
        <input type="text" value="${lesson.title}" onchange="updateLessonTitle(${si}, ${li}, this.value)" style="flex:1;border:1px solid transparent;background:transparent;font-size:var(--text-sm);padding:4px 6px;border-radius:var(--radius-sm);outline:none;min-width:0;transition:border .2s" onfocus="this.style.borderColor='var(--primary-400)';this.style.background='var(--bg-primary)'" onblur="this.style.borderColor='transparent';this.style.background='transparent'">

        <!-- Editable duration -->
        <input type="text" value="${lesson.duration}" onchange="updateLessonDuration(${si}, ${li}, this.value)" style="width:80px;text-align:center;border:1px solid transparent;background:transparent;font-size:var(--text-xs);color:var(--text-tertiary);padding:4px 6px;border-radius:var(--radius-sm);outline:none;transition:border .2s" onfocus="this.style.borderColor='var(--primary-400)';this.style.background='var(--bg-primary)'" onblur="this.style.borderColor='transparent';this.style.background='transparent'" placeholder="Duration">

        ${expandBtn}

        <!-- Duplicate button -->
        <button onclick="duplicateLesson(${si}, ${li})" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:var(--text-tertiary);padding:4px;border-radius:4px" title="Duplicate lesson" onmouseenter="this.style.color='var(--primary-600)'" onmouseleave="this.style.color='var(--text-tertiary)'"><span class="wi wi-clipboard"></span></button>

        <!-- Delete button -->
        <button onclick="deleteLesson(${si}, ${li})" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:var(--text-tertiary);padding:4px;border-radius:4px" title="Delete lesson" onmouseenter="this.style.color='#EF4444'" onmouseleave="this.style.color='var(--text-tertiary)'">✕</button>
      </div>
      ${extraContent}
    </div>`;
  }

  /* ====== SECTION OPERATIONS ====== */
  function addSection() {
    const id = Date.now();
    _curriculum.push({
      id: id,
      title: 'New Section',
      lessons: []
    });
    renderCurriculum();
    Toast.show('Section added', '', 'success', 2000);
    // Focus the new section title input
    setTimeout(() => {
      const sections = document.querySelectorAll('.builder-section');
      const last = sections[sections.length - 1];
      if (last) { const inp = last.querySelector('input[type="text"]'); if (inp) { inp.focus(); inp.select(); } }
    }, 100);
  }

  function deleteSection(index) {
    if (_curriculum.length <= 1) { Toast.show('Need at least one section', '', 'warning', 2000); return; }
    const name = _curriculum[index].title;
    if (!confirm(`Delete section "${name}" and all its lessons?`)) return;
    _curriculum.splice(index, 1);
    renderCurriculum();
    Toast.show('Section deleted', '', 'info', 2000);
  }

  function updateSectionTitle(sectionIndex, value) {
    _curriculum[sectionIndex].title = value.trim() || 'Untitled Section';
    Toast.show('Section renamed', '', 'success', 1500);
  }

  function toggleSection(btn) {
    const section = btn.closest('.builder-section');
    const lessons = section.querySelector('.section-lessons');
    if (lessons.style.display === 'none') {
      lessons.style.display = 'block';
      btn.textContent = '▼';
    } else {
      lessons.style.display = 'none';
      btn.textContent = '<span class="wi wi-video"></span>';
    }
  }

  /* ====== LESSON OPERATIONS ====== */
  function addLesson(sectionIndex) {
    const section = _curriculum[sectionIndex];
    const id = Date.now();
    section.lessons.push({ id, title: 'New Lesson', type: 'video', duration: '0:00', completed: false });
    renderCurriculum();
    Toast.show('Lesson added', '', 'success', 1500);
    // Focus the new lesson title
    setTimeout(() => {
      const sectionEl = document.querySelectorAll('.builder-section')[sectionIndex];
      if (sectionEl) {
        const lessonItems = sectionEl.querySelectorAll('.lesson-item');
        const last = lessonItems[lessonItems.length - 1];
        if (last) { const inp = last.querySelectorAll('input[type="text"]')[0]; if (inp) { inp.focus(); inp.select(); } }
      }
    }, 100);
  }

  function deleteLesson(sectionIndex, lessonIndex) {
    const lesson = _curriculum[sectionIndex].lessons[lessonIndex];
    _curriculum[sectionIndex].lessons.splice(lessonIndex, 1);
    renderCurriculum();
    Toast.show(`"${lesson.title}" deleted`, '', 'info', 2000);
  }

  function duplicateLesson(sectionIndex, lessonIndex) {
    const original = _curriculum[sectionIndex].lessons[lessonIndex];
    const copy = { ...original, id: Date.now(), title: original.title + ' (copy)', completed: false, active: false };
    _curriculum[sectionIndex].lessons.splice(lessonIndex + 1, 0, copy);
    renderCurriculum();
    Toast.show('Lesson duplicated', '', 'success', 1500);
  }

  function updateLessonTitle(sectionIndex, lessonIndex, value) {
    _curriculum[sectionIndex].lessons[lessonIndex].title = value.trim() || 'Untitled Lesson';
  }

  function updateLessonType(sectionIndex, lessonIndex, value) {
    _curriculum[sectionIndex].lessons[lessonIndex].type = value;
    // Update default duration placeholder based on type
    const defaults = { video: '0:00', quiz: '0 questions', assignment: '0 min', resource: '0 min read' };
    const lesson = _curriculum[sectionIndex].lessons[lessonIndex];
    if (lesson.duration === '0:00' || lesson.duration === '0 questions' || lesson.duration === '0 min' || lesson.duration === '0 min read') {
      lesson.duration = defaults[value] || '0:00';
    }
    renderCurriculum();
    Toast.show(`Changed to ${value}`, '', 'info', 1500);
  }

  function updateLessonDuration(sectionIndex, lessonIndex, value) {
    _curriculum[sectionIndex].lessons[lessonIndex].duration = value.trim() || '0:00';
  }

  /* ====== DRAG & DROP (Lessons) ====== */
  let dragLesson = null;

  function initLessonDragDrop() {
    document.querySelectorAll('.lesson-item').forEach(item => {
      item.addEventListener('dragstart', e => {
        dragLesson = {
          sectionIndex: parseInt(item.dataset.section),
          lessonIndex: parseInt(item.dataset.lesson)
        };
        item.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
      });

      item.addEventListener('dragend', () => {
        item.style.opacity = '1';
        dragLesson = null;
        document.querySelectorAll('.lesson-item').forEach(el => el.style.borderTop = '');
      });

      item.addEventListener('dragover', e => {
        e.preventDefault();
        if (!dragLesson) return;
        e.dataTransfer.dropEffect = 'move';
        item.style.borderTop = '2px solid var(--primary-400)';
      });

      item.addEventListener('dragleave', () => {
        item.style.borderTop = '';
      });

      item.addEventListener('drop', e => {
        e.preventDefault();
        if (!dragLesson) return;
        item.style.borderTop = '';

        const targetSection = parseInt(item.dataset.section);
        const targetLesson = parseInt(item.dataset.lesson);

        // Remove from source
        const [movedLesson] = _curriculum[dragLesson.sectionIndex].lessons.splice(dragLesson.lessonIndex, 1);

        // Adjust target index if in same section and after source
        let adjustedTarget = targetLesson;
        if (dragLesson.sectionIndex === targetSection && dragLesson.lessonIndex < targetLesson) {
          adjustedTarget--;
        }

        // Insert at target
        _curriculum[targetSection].lessons.splice(adjustedTarget, 0, movedLesson);

        dragLesson = null;
        renderCurriculum();
        Toast.show('Lesson moved', '', 'success', 1500);
      });
    });

    // Allow dropping lessons between sections
    document.querySelectorAll('.section-lessons').forEach(container => {
      container.addEventListener('dragover', e => {
        e.preventDefault();
        if (!dragLesson) return;
        e.dataTransfer.dropEffect = 'move';
      });

      container.addEventListener('drop', e => {
        if (!dragLesson || e.target.closest('.lesson-item')) return;
        e.preventDefault();

        const targetSection = parseInt(container.dataset.section);
        const [movedLesson] = _curriculum[dragLesson.sectionIndex].lessons.splice(dragLesson.lessonIndex, 1);
        _curriculum[targetSection].lessons.push(movedLesson);

        dragLesson = null;
        renderCurriculum();
        Toast.show('Lesson moved to new section', '', 'success', 1500);
      });
    });
  }

  /* ====== TAGS ====== */
  function addTag(input) {
    const value = input.value.trim();
    if (!value) return;
    const container = input.parentElement;
    const tag = document.createElement('span');
    tag.style.cssText = 'background:var(--primary-50);color:var(--primary-600);padding:4px 12px;border-radius:999px;font-size:var(--text-xs);font-weight:600;cursor:pointer';
    tag.textContent = value + ' ×';
    tag.onclick = function() { removeTag(this); };
    container.insertBefore(tag, input);
    input.value = '';
    Toast.show(`Tag "${value}" added`, '', 'success', 1500);
  }

  function removeTag(el) {
    const name = el.textContent.replace(' ×', '');
    el.remove();
    Toast.show(`Tag "${name}" removed`, '', 'info', 1500);
  }

  /* ====== THUMBNAIL UPLOAD ====== */
  function initThumbUpload() {
    const dropZone = document.getElementById('thumbDropZone');
    const fileInput = document.getElementById('thumbInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--primary-400)';
      dropZone.style.background = 'var(--primary-50)';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '';
      dropZone.style.background = '';
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.borderColor = '';
      dropZone.style.background = '';
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleThumbUpload(fileInput);
      }
    });
  }

  function handleThumbUpload(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    if (file.size > 5 * 1024 * 1024) { Toast.show('File too large', 'Max 5MB allowed', 'warning', 3000); return; }
    if (!file.type.startsWith('image/')) { Toast.show('Invalid file', 'Please upload an image', 'warning', 3000); return; }

    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('thumbPreview').innerHTML = `
        <img src="${e.target.result}" alt="Thumbnail preview" style="max-width:100%;max-height:200px;border-radius:var(--radius-md);object-fit:cover;margin-bottom:8px">
        <p style="font-size:var(--text-xs);color:var(--text-tertiary)">${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
        <button class="btn btn-ghost btn-sm" onclick="clearThumb(event)" style="margin-top:4px;font-size:11px">Remove</button>
      `;
      Toast.show('Thumbnail uploaded', '', 'success', 2000);
    };
    reader.readAsDataURL(file);
  }

  function clearThumb(e) {
    e.stopPropagation();
    document.getElementById('thumbInput').value = '';
    document.getElementById('thumbPreview').innerHTML = `
      <div style="font-size:var(--text-2xl);margin-bottom:8px"><span class="wi wi-video"></span></div>
      <p style="font-size:var(--text-sm);color:var(--text-tertiary)">Click to upload or drag and drop<br><span style="font-size:var(--text-xs)">PNG, JPG up to 5MB</span></p>
    `;
    Toast.show('Thumbnail removed', '', 'info', 1500);
  }

  /* ====== SAVE DRAFT ====== */
  function collectFormData() {
    return {
      title: document.getElementById('cbTitle').value,
      description: document.getElementById('cbDescription').value,
      category: document.getElementById('cbCategory').value,
      level: document.getElementById('cbLevel').value,
      price: parseFloat(document.getElementById('cbPrice').value) || 0,
      originalPrice: parseFloat(document.getElementById('cbOriginalPrice').value) || 0,
      tags: Array.from(document.querySelectorAll('#tagInput').closest('div').querySelectorAll('span')).map(s => s.textContent.replace(' ×', '')),
      curriculum: _curriculum,
      savedAt: new Date().toISOString()
    };
  }

  async function saveCurriculum() {
    if (!_courseId) return;
    try {
      for (let si = 0; si < _curriculum.length; si++) {
        const section = _curriculum[si];
        const sectionPayload = { course_id: _courseId, title: section.title, sort_order: si };
        let savedSection;
        if (section.id && typeof section.id === 'string' && section.id.length > 10) {
          savedSection = await WiserAPI.sections.update(section.id, sectionPayload);
        } else {
          savedSection = await WiserAPI.sections.create(sectionPayload);
          section.id = savedSection.id;
        }
        for (let li = 0; li < section.lessons.length; li++) {
          const lesson = section.lessons[li];
          const lessonPayload = {
            course_id: _courseId,
            section_id: savedSection.id,
            title: lesson.title,
            type: lesson.type,
            duration: lesson.duration,
            sort_order: li,
            video_url: lesson.videoUrl || null
          };
          if (lesson.id && typeof lesson.id === 'string' && lesson.id.length > 10) {
            await WiserAPI.lessons.update(lesson.id, lessonPayload);
          } else {
            const savedLesson = await WiserAPI.lessons.create(lessonPayload);
            lesson.id = savedLesson.id;
          }
        }
      }
    } catch (e) {
      console.error('Failed to save curriculum:', e);
      throw e;
    }
  }

  function saveDraft() {
    const data = collectFormData();
    if (!data.title.trim()) { Toast.show('Missing title', 'Enter a course title', 'error', 2500); return; }
    localStorage.setItem('wiser_course_draft', JSON.stringify(data));
    Toast.show('Draft saved!', `"${data.title}" saved at ${new Date().toLocaleTimeString()}`, 'success', 2500);
  }

  async function publishCourse() {
    const data = collectFormData();
    if (!data.title.trim()) { Toast.show('Missing title', 'Enter a course title', 'error', 2500); return; }
    if (!data.description.trim()) { Toast.show('Missing description', 'Add a course description', 'error', 2500); return; }
    if (data.price <= 0) { Toast.show('Invalid price', 'Set a price greater than $0', 'error', 2500); return; }
    const totalLessons = _curriculum.reduce((s, sec) => s + sec.lessons.length, 0);
    if (totalLessons === 0) { Toast.show('No lessons', 'Add at least one lesson before publishing', 'error', 2500); return; }
    data.published = true;
    data.publishedAt = new Date().toISOString();
    localStorage.setItem('wiser_course_draft', JSON.stringify(data));

    // Persist curriculum to backend if we have a courseId
    if (_courseId) {
      try {
        await saveCurriculum();
        await WiserAPI.courses.update(_courseId, { status: 'published', published_at: data.publishedAt });
      } catch (e) {
        Toast.show('Publish failed', e.message || 'Could not save to server', 'error', 3000);
        return;
      }
    }

    // Show proper success state on the publish button
    const publishBtn = document.querySelector('[onclick="publishCourse()"]');
    if (publishBtn) {
      publishBtn.textContent = '<span class="wi wi-check"></span> Published';
      publishBtn.style.background = '#16A34A';
      publishBtn.style.borderColor = '#16A34A';
      publishBtn.disabled = true;
      setTimeout(() => { publishBtn.textContent = 'Publish Course'; publishBtn.style.background = ''; publishBtn.style.borderColor = ''; publishBtn.disabled = false; }, 4000);
    }
    Toast.show('Course published!', `"${data.title}" is now live with ${totalLessons} lessons`, 'success', 3000);
  }

  /* ====== AI CURRICULUM GENERATOR ====== */
  function aiGenerateCurriculum() {
    const topic = document.getElementById('aiTopicInput').value.trim();
    if (!topic) { Toast.show('Enter a topic', 'Describe what your course covers', 'warning', 2500); return; }

    Toast.show('Generating...', 'AI is crafting your curriculum', 'info', 2000);

    // Simulate AI delay then generate mock curriculum
    setTimeout(() => {
      const topicClean = topic.charAt(0).toUpperCase() + topic.slice(1);
      const generated = [
        {
          id: Date.now(), title: `Introduction to ${topicClean}`,
          lessons: [
            { id: Date.now()+1, title: `What is ${topicClean}?`, type: 'video', duration: '8:00', completed: false },
            { id: Date.now()+2, title: 'Setting Up Your Environment', type: 'video', duration: '12:00', completed: false },
            { id: Date.now()+3, title: 'Course Overview & Resources', type: 'resource', duration: '5 min read', completed: false }
          ]
        },
        {
          id: Date.now()+10, title: `${topicClean} Fundamentals`,
          lessons: [
            { id: Date.now()+11, title: 'Core Concepts & Theory', type: 'video', duration: '18:00', completed: false },
            { id: Date.now()+12, title: 'Hands-On Practice', type: 'video', duration: '22:00', completed: false },
            { id: Date.now()+13, title: 'Fundamentals Quiz', type: 'quiz', duration: '15 questions', completed: false },
            { id: Date.now()+14, title: 'Practice Project', type: 'assignment', duration: '45 min', completed: false }
          ]
        },
        {
          id: Date.now()+20, title: `Advanced ${topicClean}`,
          lessons: [
            { id: Date.now()+21, title: 'Advanced Techniques', type: 'video', duration: '25:00', completed: false },
            { id: Date.now()+22, title: 'Real-World Patterns', type: 'video', duration: '30:00', completed: false },
            { id: Date.now()+23, title: 'Best Practices & Optimization', type: 'video', duration: '20:00', completed: false },
            { id: Date.now()+24, title: 'Advanced Quiz', type: 'quiz', duration: '20 questions', completed: false },
            { id: Date.now()+25, title: 'Capstone Project', type: 'assignment', duration: '2 hours', completed: false }
          ]
        }
      ];

      // Append to existing curriculum
      _curriculum.push(...generated);
      renderCurriculum();
      document.getElementById('aiTopicInput').value = '';
      const totalNew = generated.reduce((s, sec) => s + sec.lessons.length, 0);
      Toast.show('Curriculum generated!', `Added ${generated.length} sections with ${totalNew} lessons`, 'success', 3000);
    }, 1500);
  }

  /* ====== QUIZ BUILDER ====== */
  function renderQuizQuestion(q, qi, si, li) {
    return `
      <div style="border:1px solid var(--border-light);border-radius:var(--radius-md);padding:10px 12px;margin-bottom:6px;background:var(--bg-primary)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div style="font-size:var(--text-sm);font-weight:600;margin-bottom:6px">Q${qi+1}. ${q.question}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
              ${['A','B','C','D'].map(letter => `
                <div style="font-size:var(--text-xs);padding:3px 8px;border-radius:var(--radius-sm);${q.correct === letter ? 'background:#ECFDF5;color:#059669;font-weight:600' : 'color:var(--text-secondary)'}">
                  ${letter}. ${q.options[letter]}
                </div>`).join('')}
            </div>
          </div>
          <button onclick="deleteQuizQuestion(${si},${li},${qi})" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:var(--text-tertiary);padding:4px" title="Delete question" onmouseenter="this.style.color='#EF4444'" onmouseleave="this.style.color='var(--text-tertiary)'">✕</button>
        </div>
      </div>`;
  }

  function addQuizQuestion(si, li) {
    const question = document.getElementById(`quizQ-${si}-${li}`).value.trim();
    if (!question) { Toast.show('Enter a question', '', 'warning', 2000); return; }

    const options = {};
    let allFilled = true;
    ['A','B','C','D'].forEach(letter => {
      options[letter] = document.getElementById(`quizO-${si}-${li}-${letter}`).value.trim();
      if (!options[letter]) allFilled = false;
    });
    if (!allFilled) { Toast.show('Fill all 4 options', '', 'warning', 2000); return; }

    const correct = document.querySelector(`input[name="quizCorrect-${si}-${li}"]:checked`).value;

    const lesson = _curriculum[si].lessons[li];
    if (!lesson.questions) lesson.questions = [];
    lesson.questions.push({ question, options, correct });
    lesson.duration = lesson.questions.length + ' question' + (lesson.questions.length !== 1 ? 's' : '');

    renderCurriculum();
    // Re-open the quiz builder panel after re-render
    setTimeout(() => {
      const panel = document.getElementById(`quizBuilder-${si}-${li}`);
      if (panel) panel.style.display = 'block';
    }, 50);
    Toast.show('Question added', `Q${lesson.questions.length}: "${question}"`, 'success', 2000);
  }

  function deleteQuizQuestion(si, li, qi) {
    const lesson = _curriculum[si].lessons[li];
    lesson.questions.splice(qi, 1);
    lesson.duration = lesson.questions.length + ' question' + (lesson.questions.length !== 1 ? 's' : '');
    renderCurriculum();
    setTimeout(() => {
      const panel = document.getElementById(`quizBuilder-${si}-${li}`);
      if (panel) panel.style.display = 'block';
    }, 50);
    Toast.show('Question removed', '', 'info', 1500);
  }

  /* ====== LESSON PANEL TOGGLE ====== */
  function toggleLessonPanel(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }

  /* ====== VIDEO UPLOAD FOR LESSONS ====== */
  function updateLessonVideoUrl(si, li, url) {
    _curriculum[si].lessons[li].videoUrl = url;
    Toast.show('Video URL saved', '', 'success', 1500);
  }

  function handleLessonVideoFile(si, li, input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    _curriculum[si].lessons[li].videoFileName = file.name;
    const label = document.getElementById(`videoFileName-${si}-${li}`);
    if (label) label.textContent = file.name;
    Toast.show('Video file selected', file.name, 'success', 2000);
  }

  /* ====== PREVIEW COURSE ====== */
  function previewCourse() {
    const data = collectFormData();
    if (!data.title.trim()) { Toast.show('Missing title', 'Enter a course title first', 'error', 2500); return; }

    const totalLessons = _curriculum.reduce((s, sec) => s + sec.lessons.length, 0);
    const totalQuizzes = _curriculum.reduce((s, sec) => s + sec.lessons.filter(l => l.type === 'quiz').length, 0);

    // Build preview overlay
    let overlay = document.getElementById('coursePreviewOverlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'coursePreviewOverlay';
      document.body.appendChild(overlay);
    }

    overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;padding:20px';
    overlay.innerHTML = `
      <div style="background:var(--bg-primary);border-radius:var(--radius-xl,16px);max-width:700px;width:100%;max-height:85vh;overflow-y:auto;padding:32px;position:relative;box-shadow:0 25px 50px rgba(0,0,0,0.25);color:var(--text-primary)">
        <button onclick="document.getElementById('coursePreviewOverlay').style.display='none'" style="position:absolute;top:16px;right:16px;border:none;background:transparent;font-size:20px;cursor:pointer;color:var(--text-tertiary)">✕</button>
        <div style="margin-bottom:20px">
          <span style="font-size:var(--text-xs);font-weight:600;color:var(--primary-600);background:var(--primary-50);padding:4px 10px;border-radius:999px">${data.category || 'Uncategorized'}</span>
          <span style="font-size:var(--text-xs);font-weight:600;color:var(--text-tertiary);margin-left:8px">${data.level || 'All Levels'}</span>
        </div>
        <h2 style="font-size:var(--text-xl);font-weight:800;margin-bottom:8px">${data.title}</h2>
        <p style="font-size:var(--text-sm);color:var(--text-secondary);margin-bottom:16px;line-height:1.6">${data.description}</p>
        <div style="display:flex;gap:16px;margin-bottom:20px;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-md)">
          <div style="text-align:center"><div style="font-size:var(--text-lg);font-weight:700">${_curriculum.length}</div><div style="font-size:var(--text-xs);color:var(--text-tertiary)">Sections</div></div>
          <div style="text-align:center"><div style="font-size:var(--text-lg);font-weight:700">${totalLessons}</div><div style="font-size:var(--text-xs);color:var(--text-tertiary)">Lessons</div></div>
          <div style="text-align:center"><div style="font-size:var(--text-lg);font-weight:700">${totalQuizzes}</div><div style="font-size:var(--text-xs);color:var(--text-tertiary)">Quizzes</div></div>
          <div style="text-align:center"><div style="font-size:var(--text-lg);font-weight:700">$${data.price.toFixed(2)}</div><div style="font-size:var(--text-xs);color:var(--text-tertiary)">Price</div></div>
        </div>
        <h3 style="font-size:var(--text-sm);font-weight:700;margin-bottom:12px">Curriculum Preview</h3>
        ${_curriculum.map((sec, si) => `
          <div style="margin-bottom:12px">
            <div style="font-weight:600;font-size:var(--text-sm);margin-bottom:6px;color:var(--text-primary)">${si+1}. ${sec.title}</div>
            ${sec.lessons.map(l => {
              const icons = {video:'<span class="wi wi-video"></span>',quiz:'<span class="wi wi-edit"></span>',assignment:'<span class="wi wi-clipboard"></span>',resource:'<span class="wi wi-file"></span>'};
              return `<div style="display:flex;align-items:center;gap:8px;padding:4px 0 4px 16px;font-size:var(--text-xs);color:var(--text-secondary)">${icons[l.type]||'<span class="wi wi-file"></span>'} ${l.title} <span style="margin-left:auto;color:var(--text-tertiary)">${l.duration}</span></div>`;
            }).join('')}
          </div>`).join('')}
        <div style="text-align:right;margin-top:20px">
          <button class="btn btn-primary btn-sm" onclick="document.getElementById('coursePreviewOverlay').style.display='none'">Close Preview</button>
        </div>
      </div>`;
    Toast.show('Preview opened', '', 'info', 1500);
  }
</script>
</body>
</html>
