<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community — Wiser</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/teacher.css">
  <style>
    /* ===== Community Groups Sidebar ===== */
    .community-groups-sidebar{width:240px;flex-shrink:0;}
    .community-groups-sidebar .group-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-md);cursor:pointer;transition:all .2s;margin-bottom:4px;position:relative;}
    .community-groups-sidebar .group-item:hover{background:var(--bg-secondary);}
    .community-groups-sidebar .group-item.active{background:var(--primary-50,rgba(159,232,112,.1));border:1px solid var(--primary-200,rgba(159,232,112,.3));}
    .community-groups-sidebar .group-icon{width:36px;height:36px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
    .community-groups-sidebar .group-info{flex:1;min-width:0;}
    .community-groups-sidebar .group-name{font-size:var(--text-sm);font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .community-groups-sidebar .group-members{font-size:var(--text-xs);color:var(--text-tertiary);}
    .community-groups-sidebar .group-unread{min-width:20px;height:20px;border-radius:10px;background:var(--primary-600,#3d8b1c);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 5px;}

    /* ===== Floating Chat Widget ===== */
    .chat-fab{position:fixed;bottom:28px;right:28px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#3d8b1c,#2d6914);color:#fff;border:none;cursor:pointer;font-size:26px;box-shadow:0 4px 16px rgba(61,139,28,.4);z-index:900;display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;}
    .chat-fab:hover{transform:scale(1.08);box-shadow:0 6px 24px rgba(61,139,28,.5);}
    .chat-fab .fab-badge{position:absolute;top:2px;right:2px;min-width:18px;height:18px;border-radius:9px;background:#DC2626;color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px;}

    .chat-panel{position:fixed;bottom:96px;right:28px;width:380px;height:520px;background:var(--bg-primary, #fff);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.18);z-index:901;display:none;flex-direction:column;overflow:hidden;border:1px solid var(--border-light);}
    .chat-panel.open{display:flex;animation:chatSlideUp .25s ease;}
    @keyframes chatSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    .chat-panel-header{padding:14px 16px;background:linear-gradient(135deg,#3d8b1c,#2d6914);color:#fff;display:flex;align-items:center;gap:10px;flex-shrink:0;}
    .chat-panel-header .chat-back{background:none;border:none;color:#fff;cursor:pointer;font-size:18px;padding:2px 4px;display:none;}
    .chat-panel-header .chat-back.show{display:inline-block;}
    .chat-panel-header .chat-header-title{flex:1;font-weight:700;font-size:15px;}
    .chat-panel-header .chat-close{background:none;border:none;color:#fff;cursor:pointer;font-size:20px;padding:2px 6px;opacity:.8;}
    .chat-panel-header .chat-close:hover{opacity:1;}

    .chat-contacts{flex:1;overflow-y:auto;}
    .chat-contact-item{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border-light);}
    .chat-contact-item:hover{background:var(--bg-secondary);}
    .chat-contact-item .contact-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0;}
    .chat-contact-item .contact-info{flex:1;min-width:0;}
    .chat-contact-item .contact-name{font-size:var(--text-sm);font-weight:600;}
    .chat-contact-item .contact-preview{font-size:var(--text-xs);color:var(--text-tertiary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .chat-contact-item .contact-time{font-size:11px;color:var(--text-tertiary);white-space:nowrap;}
    .chat-contact-item .contact-unread-dot{width:10px;height:10px;border-radius:50%;background:#3d8b1c;flex-shrink:0;}

    .chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}
    .chat-bubble{max-width:78%;padding:10px 14px;border-radius:14px;font-size:var(--text-sm);line-height:1.45;position:relative;}
    .chat-bubble.other{align-self:flex-start;background:var(--bg-secondary);border-bottom-left-radius:4px;}
    .chat-bubble.self{align-self:flex-end;background:linear-gradient(135deg,#3d8b1c,#2d6914);color:#fff;border-bottom-right-radius:4px;}
    .chat-bubble .bubble-author{font-size:11px;font-weight:700;margin-bottom:2px;}
    .chat-bubble.self .bubble-author{color:rgba(255,255,255,.85);}
    .chat-bubble .bubble-time{font-size:10px;margin-top:4px;opacity:.6;}

    .chat-input-bar{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border-light);flex-shrink:0;background:var(--bg-primary, #fff);}
    .chat-input-bar input{flex:1;padding:8px 14px;border:1px solid var(--border-light);border-radius:20px;font-size:var(--text-sm);outline:none;}
    .chat-input-bar input:focus{border-color:#3d8b1c;}
    .chat-input-bar button{padding:8px 16px;border-radius:20px;background:linear-gradient(135deg,#3d8b1c,#2d6914);color:#fff;border:none;cursor:pointer;font-size:var(--text-sm);font-weight:600;}
    .chat-input-bar button:hover{opacity:.9;}

    @media(max-width:768px){
      .community-groups-sidebar{width:100%;}
      .chat-panel{width:calc(100vw - 24px);right:12px;bottom:84px;height:60vh;}
    }
  </style>
  <script>(function(){var t=localStorage.getItem('wiser_theme');if(t==='dark')document.documentElement.setAttribute('data-theme','dark')})()</script>
</head>
<body>
<div class="teacher-page">

  <!-- ========== TOP NAVBAR ========== -->
  <nav class="teacher-topbar">
    <div class="teacher-topbar-inner">
      <a href="../index.html" class="teacher-topbar-logo"><img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-dark"></a>
      <div class="teacher-topbar-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="schools.html">Schools</a>
        <a href="creator-hub.html">My Courses</a>
        <a href="analytics.html">Analytics</a>
        <a href="community.html">Community</a>
        <a href="payout.html">Payout</a>
      </div>
      <div class="teacher-topbar-actions">
        <button class="theme-toggle" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode" ><svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
        <button class="stu-notif-btn" onclick="document.querySelector('.stu-notif-panel').classList.toggle('active');document.querySelector('.stu-notif-backdrop').classList.toggle('active')" ><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="stu-notif-badge">2</span></button>
        <a href="course-builder.html" class="btn btn-primary btn-sm">Create a New Course &rarr;</a>
        <button class="teacher-topbar-toggle" onclick="document.querySelector('.teacher-mobile-menu').classList.toggle('active');document.querySelector('.teacher-mobile-overlay').classList.toggle('active')" aria-label="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Teacher Mobile Menu -->
  <div class="teacher-mobile-overlay" onclick="this.classList.remove('active');document.querySelector('.teacher-mobile-menu').classList.remove('active')"></div>
  <div class="teacher-mobile-menu">
    <a href="dashboard.html">Dashboard</a>
    <a href="schools.html">Schools</a>
    <a href="creator-hub.html">My Courses</a>
    <a href="analytics.html">Analytics</a>
    <a href="community.html">Community</a>
    <a href="payout.html">Payout</a>
    <a href="settings.html">Settings</a>
    <a href="course-builder.html">Create a New Course</a>
  </div>

  <!-- Notification Panel -->
  <div class="stu-notif-backdrop" onclick="this.classList.remove('active');document.querySelector('.stu-notif-panel').classList.remove('active')"></div>
  <div class="stu-notif-panel">
    <div class="stu-notif-panel-header"><h3 style="font-size:16px;font-weight:700;">Notifications</h3><button class="stu-notif-mark-all" onclick="document.querySelectorAll('.stu-notif-item').forEach(i=>i.classList.remove('unread'));this.style.display='none';document.querySelector('.stu-notif-badge').style.display='none';">Mark all read</button></div>
    <div class="stu-notif-list" id="notifList"></div>
  </div>

  <!-- ========== COVER BANNER ========== -->
  <div class="teacher-cover-banner">
    <div class="teacher-cover-content">
      <div class="teacher-cover-label">Bootcamp Instructor</div>
      <h1 class="teacher-cover-name">Learn With Sarah</h1>
    </div>
  </div>
  <div class="teacher-profile-bar">
    <div class="teacher-profile-avatar"><img src="../assets/Teacher-Student/1.png" alt="Sarah Chen"></div>
    <div class="teacher-profile-info"><div class="teacher-profile-info-name">Sarah Chen</div><div class="teacher-profile-rating"><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span><span class="wi wi-star"></span> <span style="color:rgba(255,255,255,0.7);margin-left:4px">(35 Reviews)</span></div></div>
    <div class="teacher-profile-cta"><a href="course-builder.html" class="btn">Create a New Course &rarr;</a></div>
  </div>

  <!-- ========== MAIN BODY ========== -->
  <div class="teacher-body">
    <!-- Left Sidebar Navigation -->
    <aside class="teacher-sidebar-card">
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">Welcome, Sarah Chen</div>
        <a href="dashboard.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</a>
        <a href="schools.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Schools</a>
        <a href="analytics.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg> Analytics</a>
        <a href="payout.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Payout</a>
      </div>
      <div class="teacher-sidebar-divider"></div>
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">Instructor</div>
        <a href="creator-hub.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> My Courses</a>
        <a href="course-builder.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> Course Builder</a>
        <a href="community.html" class="teacher-nav-link active"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> Community</a>
        <a href="store-manager.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg> Store Manager</a>
      </div>
      <div class="teacher-sidebar-divider"></div>
      <div class="teacher-sidebar-section">
        <div class="teacher-sidebar-label">User</div>
        <a href="settings.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> Settings</a>
        <a href="../auth/login.html" class="teacher-nav-link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> Logout</a>
      </div>
    </aside>

    <!-- Right Content Area -->
    <div class="teacher-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-4)">
        <h2 class="teacher-content-title" style="margin-bottom:0">Community</h2>
        <button class="btn btn-primary btn-sm" onclick="createGroup()">+ Create Group</button>
      </div>

      <div style="display:flex;gap:20px;align-items:flex-start;">
        <!-- Groups Sidebar -->
        <div class="community-groups-sidebar">
          <div class="teacher-card" style="padding:12px;">
            <div style="font-size:var(--text-xs);font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;padding:0 4px;">Groups</div>
            <div id="groupsList"></div>
          </div>
        </div>

        <!-- Feed Column -->
        <div style="flex:1;min-width:0;">
          <!-- Pinned Posts -->
          <div id="pinnedPosts"></div>

          <!-- Posts Feed -->
          <div>
          <div class="teacher-card">
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div class="teacher-profile-avatar" style="width:40px;height:40px;font-size:var(--text-sm);border:none"><img src="../assets/Teacher-Student/1.png" alt="Sarah Chen"></div>
              <div style="flex:1">
                <textarea class="form-input" rows="3" placeholder="Share an update with your community..." id="postInput" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm);resize:vertical"></textarea>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                  <div style="display:flex;gap:8px">
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('photoInput').click()"><span class="wi wi-video"></span> Photo</button>
                    <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhotoAttach(this)">
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('docInput').click()"><span class="wi wi-file"></span> Document</button>
                    <input type="file" id="docInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt" style="display:none" onchange="handleDocAttach(this)">
                  </div>
                  <button class="btn btn-primary btn-sm" onclick="addPost()">Post</button>
                </div>
                <div id="attachmentPreview" style="margin-top:8px;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius-md);font-size:var(--text-sm);display:none"></div>
              </div>
            </div>
          </div>
          <div id="postsFeed"></div>
          </div>
        </div><!-- /feed column -->
      </div><!-- /flex row -->
    </div>
  </div>

  <!-- ========== FLOATING CHAT WIDGET ========== -->
  <button class="chat-fab" onclick="toggleChatPanel()" title="Messages">
    <span class="wi wi-message"></span>
    <span class="fab-badge" id="chatFabBadge">2</span>
  </button>
  <div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header">
      <button class="chat-back" id="chatBackBtn" onclick="showContactsList()">←</button>
      <div class="chat-header-title" id="chatHeaderTitle">Messages</div>
      <button class="chat-close" onclick="toggleChatPanel()">✕</button>
    </div>
    <div class="chat-contacts" id="chatContacts"></div>
    <div class="chat-messages" id="chatMessages" style="display:none;"></div>
    <div class="chat-input-bar" id="chatInputBar" style="display:none;">
      <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()">Send</button>
    </div>
  </div>

  <!-- ========== FOOTER ========== -->
  <footer class="teacher-footer">
    <div class="teacher-footer-inner">
      <div class="teacher-footer-grid">
        <div><div class="teacher-footer-brand"><img src="../assets/logo-Light-Theme.png" alt="Wiser" class="logo-light"><img src="../assets/Logo-Dark-Theme.png" alt="Wiser" class="logo-dark"><span>Wiser</span></div><p class="teacher-footer-desc">We're always in search for talented and motivated people.</p><div class="teacher-footer-socials"><a href="#" class="teacher-footer-social-icon">f</a><a href="#" class="teacher-footer-social-icon">t</a><a href="#" class="teacher-footer-social-icon">in</a><a href="#" class="teacher-footer-social-icon">ig</a></div></div>
        <div><h4>Useful Links</h4><div class="teacher-footer-links"><a href="#">Marketplace</a><a href="#">Courses</a><a href="#">Community</a><a href="#">FAQ</a><a href="#">About Us</a></div></div>
        <div><h4>Our Company</h4><div class="teacher-footer-links"><a href="#">Contact Us</a><a href="schools.html">Invite Teachers</a><a href="#">Blog</a><a href="#">Events</a><a href="#">Careers</a></div></div>
        <div><h4>Get in Touch</h4><p style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-2)">Phone: (406) 555-0120<br>Email: admin@wiser.com</p><div class="teacher-footer-newsletter-form"><input type="email" placeholder="Enter Your Email Here"><button>Submit Now</button></div></div>
      </div>
      <div class="teacher-footer-bottom"><span>Copyright &copy; 2026 <strong>Wiser</strong>. All Rights Reserved</span><div class="teacher-footer-bottom-links"><a href="#">Terms of Service</a><a href="#">Privacy Policy</a><a href="../auth/login.html">Login &amp; Register</a></div></div>
    </div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.2/dist/umd/supabase.min.js" integrity="sha384-zhtfJ1S/qkpAToBl4XpbM2NH5uZgfUq2z4qo30Ed7TxgPxmkM+L1Gm94iyexzcJ6" crossorigin="anonymous"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
<script src="../js/app.js"></script>
<script>
  // Module-level data variables
  let _communityPosts = [];
  let _communityGroups = [];
  let _teacherMessages = [];
  let _chatMessages = [];
  let _displayName = 'Teacher';
  let _firstName = 'Teacher';

  document.addEventListener('DOMContentLoaded', async () => {
    // Auth guard — server-side role verification
    const __authProfile = await WiserAuth.requireAuth(['teacher', 'admin']);
    if (!__authProfile) return;

    // Load profile
    try {
      const profile = await WiserAPI.profiles.getCurrent();
      if (profile) {
        _displayName = profile.display_name || ((profile.first_name || '') + ' ' + (profile.last_name || '')).trim() || 'Teacher';
        _firstName = profile.first_name || _displayName.split(' ')[0];
      }
    } catch(e) { console.warn('Could not load profile', e); }

    // Update hardcoded name references in DOM
    const coverName = document.querySelector('.teacher-cover-name');
    if (coverName) coverName.textContent = 'Learn With ' + _firstName;
    const profileInfoName = document.querySelector('.teacher-profile-info-name');
    if (profileInfoName) profileInfoName.textContent = _displayName;
    document.querySelectorAll('.teacher-sidebar-label').forEach(el => {
      if (el.textContent.includes('Welcome,')) el.textContent = 'Welcome, ' + _displayName;
    });
    const commAvatar = document.querySelector('.teacher-profile-avatar img');
    if (commAvatar && profile && profile.avatar_url) commAvatar.src = profile.avatar_url;
    const commCoverBanner = document.querySelector('.teacher-cover-banner');
    if (commCoverBanner && profile && profile.cover_photo_url) { commCoverBanner.style.backgroundImage = 'url(' + profile.cover_photo_url + ')'; commCoverBanner.style.backgroundSize = 'cover'; }

    // Load data
    _communityPosts = await WiserData.getCommunityPosts();
    _communityGroups = await WiserData.getCommunityGroups();
    _teacherMessages = await WiserData.getTeacherMessages();
    _chatMessages = await WiserData.getChatMessages();

    renderPosts();
    renderPinnedPosts();
    renderGroupsList();
    renderChatContacts();
  });

  // Close mod menus when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.mod-menu') && !e.target.closest('[onclick*="toggleModMenu"]')) {
      document.querySelectorAll('.mod-menu').forEach(m => m.style.display = 'none');
    }
  });

  function toggleModMenu(e, idx) {
    e.stopPropagation();
    document.querySelectorAll('.mod-menu').forEach(m => m.style.display = 'none');
    const menu = document.getElementById('modMenu-' + idx);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }

  async function pinPost(idx) {
    const post = _communityPosts[idx];
    const newPinned = !post.pinned;
    try {
      await WiserAPI.community.updatePost(post.id, { pinned: newPinned });
    } catch(e) { console.error('Failed to pin/unpin post', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    Toast.show(newPinned ? 'Post pinned!' : 'Post unpinned', '', 'success', 1500);
    renderPosts();
    renderPinnedPosts();
  }

  function flagPost(idx) {
    const post = _communityPosts[idx];
    post.flagged = true;
    Toast.show('Content flagged', 'This post has been flagged for review', 'warning', 2000);
    document.querySelectorAll('.mod-menu').forEach(m => m.style.display = 'none');
    const cards = document.querySelectorAll('#postsFeed .teacher-card');
    if (cards[idx]) {
      const existing = cards[idx].querySelector('.flagged-banner');
      if (!existing) {
        const banner = document.createElement('div');
        banner.className = 'flagged-banner';
        banner.style.cssText = 'background:#FEE2E2;color:#DC2626;padding:6px 12px;border-radius:var(--radius-md);font-size:var(--text-xs);font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px';
        banner.innerHTML = '<span class="wi wi-alert"></span> Flagged for Review';
        cards[idx].insertBefore(banner, cards[idx].firstChild);
      }
    }
  }

  async function banUser(idx) {
    const post = _communityPosts[idx];
    if (!confirm(`Are you sure you want to ban ${post.author}? This action cannot be undone.`)) return;
    const bannedAuthor = post.author;
    try {
      const postsToDelete = _communityPosts.filter(p => p.author === bannedAuthor);
      for (const p of postsToDelete) {
        await WiserAPI.community.deletePost(p.id);
      }
    } catch(e) { console.error('Failed to ban user', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    renderPosts();
    renderPinnedPosts();
    Toast.show('User banned', `${bannedAuthor} has been banned and their posts removed`, 'error', 3000);
  }

  function renderPinnedPosts() {
    const pinned = _communityPosts.filter(p => p.pinned);
    const container = document.getElementById('pinnedPosts');
    if (!pinned.length) { container.innerHTML = ''; return; }
    container.innerHTML = `
      <div class="teacher-card" style="border-left:3px solid var(--primary-600);margin-bottom:var(--space-4)">
        <div style="font-size:var(--text-xs);font-weight:700;color:var(--primary-600);margin-bottom:8px"><span class="wi wi-pin"></span> PINNED</div>
        ${pinned.map(p => {
          const isOwn = p.author === _displayName;
          const profileImg = p.profileImage || (isOwn ? '../assets/Teacher-Student/1.png' : '');
          const avatarHTML = profileImg
            ? `<img src="${profileImg}" alt="${p.author}" style="width:28px;height:28px;border-radius:50%;object-fit:cover">`
            : `<div style="width:28px;height:28px;border-radius:50%;background:${p.avatar || 'linear-gradient(135deg, #3d8b1c, #9fe870)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700">${p.initials || '??'}</div>`;
          return `<div style="display:flex;gap:8px;align-items:center;padding:6px 0;${pinned.indexOf(p) < pinned.length - 1 ? 'border-bottom:1px solid var(--border-light)' : ''}">
            ${avatarHTML}
            <div style="flex:1"><strong style="font-size:var(--text-xs)">${p.author}</strong> <span style="font-size:var(--text-xs);color:var(--text-tertiary)">${p.time}</span><p style="font-size:var(--text-sm);margin:2px 0 0">${p.text.length > 120 ? p.text.substring(0, 120) + '…' : p.text}</p></div>
          </div>`;
        }).join('')}
      </div>`;
  }

  function renderPosts() {
    document.getElementById('postsFeed').innerHTML = _communityPosts.map((p, idx) => {
      const badge = p.badge || '';
      const replyCount = p.replies ?? 0;
      const liked = p.liked ? 'color:var(--primary-600);font-weight:700' : '';
      const isOwn = p.author === _displayName;
      const profileImg = p.profileImage || (isOwn ? '../assets/Teacher-Student/1.png' : '');
      const avatarHTML = profileImg
        ? `<img src="${profileImg}" alt="${p.author}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0">`
        : `<div style="width:36px;height:36px;border-radius:50%;background:${p.avatar || 'linear-gradient(135deg, #3d8b1c, #9fe870)'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;flex-shrink:0">${p.initials || p.author?.split(' ').map(w => w[0]).join('').toUpperCase() || '??'}</div>`;
      return `
      <div class="teacher-card" style="margin-top:var(--space-4)">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
          ${avatarHTML}
          <div style="flex:1"><strong style="font-size:var(--text-sm)">${p.author}</strong> ${badge ? `<span class="teacher-badge primary">${badge}</span>` : ''}<br><span style="font-size:var(--text-xs);color:var(--text-tertiary)">${p.time}</span></div>
          <div style="display:flex;gap:4px;align-items:center">
            ${isOwn ? `<button style="background:none;border:none;cursor:pointer;font-size:var(--text-sm);color:var(--text-tertiary)" onclick="editPost(${idx})" title="Edit post"><span class="wi wi-pencil"></span></button><button style="background:none;border:none;cursor:pointer;font-size:var(--text-sm);color:var(--text-tertiary)" onclick="deletePost(${idx})" title="Delete post"><span class="wi wi-trash"></span></button>` : ''}
            <div style="position:relative">
              <button style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-tertiary);padding:2px 6px;line-height:1" onclick="toggleModMenu(event,${idx})" title="Moderation">⋮</button>
              <div class="mod-menu" id="modMenu-${idx}" style="display:none;position:absolute;right:0;top:100%;background:var(--bg-primary, #fff);border:1px solid var(--border-light);border-radius:var(--radius-md);box-shadow:0 4px 12px rgba(0,0,0,.12);min-width:160px;z-index:50;overflow:hidden">
                <button style="display:block;width:100%;text-align:left;padding:8px 14px;border:none;background:none;cursor:pointer;font-size:var(--text-sm);white-space:nowrap" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'" onclick="pinPost(${idx})">${p.pinned ? '<span class="wi wi-pin"></span> Unpin Post' : '<span class="wi wi-pin"></span> Pin Post'}</button>
                <button style="display:block;width:100%;text-align:left;padding:8px 14px;border:none;background:none;cursor:pointer;font-size:var(--text-sm);white-space:nowrap" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'" onclick="flagPost(${idx})"><span class="wi wi-alert"></span> Flag Content</button>
                ${!isOwn ? `<button style="display:block;width:100%;text-align:left;padding:8px 14px;border:none;background:none;cursor:pointer;font-size:var(--text-sm);color:#DC2626;white-space:nowrap" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='none'" onclick="banUser(${idx})"><span class="wi wi-x"></span> Ban User</button>` : ''}
              </div>
            </div>
          </div>
        </div>
        <p style="font-size:var(--text-sm);margin-bottom:12px">${p.text}</p>
        <div style="display:flex;gap:16px;font-size:var(--text-sm)">
          <button style="background:none;border:none;cursor:pointer;${liked}" onclick="toggleLike(${idx})"><span class="wi wi-heart"></span> <span>${p.likes}</span></button>
          <button style="background:none;border:none;cursor:pointer" onclick="toggleReply(this, ${idx})"><span class="wi wi-message"></span> <span>${replyCount}</span></button>
          <button style="background:none;border:none;cursor:pointer" onclick="sharePost(${idx})"><span class="wi wi-link"></span> Share</button>
        </div>
        <div class="reply-area" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-light)">
          <div style="display:flex;gap:8px">
            <input type="text" class="form-input" placeholder="Write a reply..." style="flex:1;padding:8px 12px;border:1px solid var(--border-light);border-radius:var(--radius-md);font-size:var(--text-sm)" onkeydown="if(event.key==='Enter') submitReply(${idx}, this)">
            <button class="btn btn-primary btn-sm" onclick="submitReply(${idx}, this.previousElementSibling)">Reply</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  async function toggleLike(postIndex) {
    const post = _communityPosts[postIndex];
    try {
      await WiserAPI.community.likePost(post.id);
    } catch(e) { console.error('Failed to like post', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    renderPosts();
  }

  function toggleReply(btn, postIndex) {
    const card = btn.closest('.teacher-card');
    const replyArea = card.querySelector('.reply-area');
    replyArea.style.display = replyArea.style.display === 'none' ? 'block' : 'none';
    if (replyArea.style.display === 'block') replyArea.querySelector('input').focus();
  }

  async function submitReply(postIndex, input) {
    const text = input.value.trim();
    if (!text) return;
    const post = _communityPosts[postIndex];
    try {
      await WiserAPI.community.replyToPost(post.id, text);
    } catch(e) { console.error('Failed to reply', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    input.value = '';
    renderPosts();
    Toast.show('Reply posted!', '', 'success', 1500);
  }

  function sharePost(postIndex) {
    const post = _communityPosts[postIndex];
    const shareText = `${post.author}: ${post.text.substring(0, 100)}...`;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(shareText).then(() => {
        Toast.show('Link copied!', 'Post link copied to clipboard', 'success', 2000);
      });
    } else {
      Toast.show('Shared!', '', 'success', 2000);
    }
  }

  async function createGroup() {
    const name = prompt('Enter group name:');
    if (!name || !name.trim()) return;
    const icons = ['<span class="wi wi-message"></span>', '<span class="wi wi-bulb"></span>', '<span class="wi wi-target"></span>', '<span class="wi wi-rocket"></span>', '<span class="wi wi-book"></span>', '<span class="wi wi-zap"></span>'];
    try {
      await WiserAPI.community.createGroup({
        name: name.trim(), members: 1, icon: icons[Math.floor(Math.random() * icons.length)],
        iconBg: 'linear-gradient(135deg, #3d8b1c, #2d6914)', active: false, unread: 0
      });
    } catch(e) { console.error('Failed to create group', e); }
    _communityGroups = await WiserData.getCommunityGroups();
    renderGroupsList();
    Toast.show('Group created!', `"${name.trim()}" is now live`, 'success', 2000);
  }

  // ===== GROUP MANAGEMENT =====
  function renderGroupsList() {
    const container = document.getElementById('groupsList');
    container.innerHTML = _communityGroups.map((g, i) => `
      <div class="group-item ${g.active ? 'active' : ''}" onclick="switchGroup(${i})">
        <div class="group-icon" style="background:${g.iconBg}">${g.icon}</div>
        <div class="group-info">
          <div class="group-name">${g.name}</div>
          <div class="group-members">${g.members.toLocaleString()} members</div>
        </div>
        ${g.unread > 0 ? `<div class="group-unread">${g.unread}</div>` : ''}
      </div>
    `).join('');
  }

  function switchGroup(index) {
    _communityGroups.forEach((g, i) => { g.active = (i === index); });
    const group = _communityGroups[index];
    group.unread = 0;
    document.querySelector('.teacher-content-title').textContent = 'Community — ' + group.name;
    renderGroupsList();
    Toast.show('Switched group', group.icon + ' ' + group.name, 'success', 1500);
  }

  // ===== CHAT / DM SYSTEM =====
  let chatCurrentContact = null;

  function toggleChatPanel() {
    const panel = document.getElementById('chatPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open') && !chatCurrentContact) {
      showContactsList();
    }
  }

  function renderChatContacts() {
    const container = document.getElementById('chatContacts');
    const colors = ['#667eea','#f093fb','#4facfe','#a18cd1','#9fe870'];
    container.innerHTML = _teacherMessages.map((m, i) => `
      <div class="chat-contact-item" onclick="openChat('${m.id}', '${m.from}', '${m.avatar}')">
        <div class="contact-avatar" style="background:${colors[i % colors.length]}">${m.avatar}</div>
        <div class="contact-info">
          <div class="contact-name">${m.from}</div>
          <div class="contact-preview">${m.preview}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="contact-time">${m.time}</span>
          ${m.unread ? '<div class="contact-unread-dot"></div>' : ''}
        </div>
      </div>
    `).join('');
  }

  function showContactsList() {
    chatCurrentContact = null;
    document.getElementById('chatHeaderTitle').textContent = 'Messages';
    document.getElementById('chatBackBtn').classList.remove('show');
    document.getElementById('chatContacts').style.display = 'block';
    document.getElementById('chatMessages').style.display = 'none';
    document.getElementById('chatInputBar').style.display = 'none';
    renderChatContacts();
  }

  async function openChat(userId, contactName, initials) {
    chatCurrentContact = { userId: userId, name: contactName, initials: initials };
    document.getElementById('chatHeaderTitle').textContent = contactName;
    document.getElementById('chatBackBtn').classList.add('show');
    document.getElementById('chatContacts').style.display = 'none';
    document.getElementById('chatMessages').style.display = 'flex';
    document.getElementById('chatInputBar').style.display = 'flex';
    try {
      _chatMessages = await WiserData.getChatMessages(userId);
    } catch(e) { console.error('Failed to load chat messages', e); }
    renderChatMessages();
    const msgArea = document.getElementById('chatMessages');
    msgArea.scrollTop = msgArea.scrollHeight;
  }

  function renderChatMessages() {
    const container = document.getElementById('chatMessages');
    container.innerHTML = _chatMessages.map(m => `
      <div class="chat-bubble ${m.self ? 'self' : 'other'}">
        <div class="bubble-author">${m.author}</div>
        <div>${m.text}</div>
        <div class="bubble-time">${m.time}</div>
      </div>
    `).join('');
  }

  async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !chatCurrentContact) return;
    try {
      await WiserAPI.chat.send(chatCurrentContact.userId, text);
    } catch(e) { console.error('Failed to send message', e); }
    try {
      _chatMessages = await WiserData.getChatMessages(chatCurrentContact.userId);
    } catch(e) { console.error('Failed to refresh messages', e); }
    input.value = '';
    renderChatMessages();
    const msgArea = document.getElementById('chatMessages');
    msgArea.scrollTop = msgArea.scrollHeight;
  }

  async function editPost(postIndex) {
    const post = _communityPosts[postIndex];
    const newText = prompt('Edit your post:', post.text);
    if (newText === null || !newText.trim()) return;
    try {
      await WiserAPI.community.updatePost(post.id, { text: newText.trim() });
    } catch(e) { console.error('Failed to edit post', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    renderPosts();
    Toast.show('Post updated!', '', 'success', 1500);
  }

  async function deletePost(postIndex) {
    if (!confirm('Are you sure you want to delete this post?')) return;
    const post = _communityPosts[postIndex];
    try {
      await WiserAPI.community.deletePost(post.id);
    } catch(e) { console.error('Failed to delete post', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    renderPosts();
    Toast.show('Post deleted', '', 'success', 1500);
  }

  let pendingAttachment = null;

  function handlePhotoAttach(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    pendingAttachment = { type: 'photo', file };
    const preview = document.getElementById('attachmentPreview');
    const url = URL.createObjectURL(file);
    preview.style.display = 'block';
    preview.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><img src="' + url + '" style="width:60px;height:60px;object-fit:cover;border-radius:var(--radius-md)"><div style="flex:1"><strong>' + WiserSanitize.e(file.name) + '</strong><br><span style="color:var(--text-tertiary);font-size:var(--text-xs)">' + (file.size / 1024).toFixed(1) + ' KB</span></div><button onclick="clearAttachment()" style="border:none;background:none;cursor:pointer;font-size:16px;color:var(--text-tertiary)">✕</button></div>';
    Toast.show('Photo attached', WiserSanitize.e(file.name), 'success', 2000);
  }

  function handleDocAttach(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    pendingAttachment = { type: 'document', file };
    const preview = document.getElementById('attachmentPreview');
    preview.style.display = 'block';
    preview.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:24px"><span class="wi wi-file"></span></span><div style="flex:1"><strong>' + WiserSanitize.e(file.name) + '</strong><br><span style="color:var(--text-tertiary);font-size:var(--text-xs)">' + (file.size / 1024).toFixed(1) + ' KB</span></div><button onclick="clearAttachment()" style="border:none;background:none;cursor:pointer;font-size:16px;color:var(--text-tertiary)">✕</button></div>';
    Toast.show('Document attached', WiserSanitize.e(file.name), 'success', 2000);
  }

  function clearAttachment() {
    pendingAttachment = null;
    document.getElementById('attachmentPreview').style.display = 'none';
    document.getElementById('attachmentPreview').innerHTML = '';
    document.getElementById('photoInput').value = '';
    document.getElementById('docInput').value = '';
  }

  async function addPost() {
    const input = document.getElementById('postInput');
    const text = input.value.trim();
    if (!text) return;
    const initials = _displayName.split(' ').map(w => w[0]).join('').toUpperCase();
    const newPost = { author: _displayName, initials: initials, avatar: 'linear-gradient(135deg, #3d8b1c, #2d6914)', profileImage: '../assets/Teacher-Student/1.png', badge: 'Instructor', text, time: 'Just now', likes: 0, replies: 0, liked: false };
    if (pendingAttachment) {
      newPost.attachment = { type: pendingAttachment.type, name: pendingAttachment.file.name };
    }
    try {
      await WiserAPI.community.createPost(newPost);
    } catch(e) { console.error('Failed to create post', e); }
    _communityPosts = await WiserData.getCommunityPosts();
    renderPosts();
    input.value = '';
    clearAttachment();
    Toast.show('Post published!', '', 'success', 2000);
  }
</script>
</body>
</html>
